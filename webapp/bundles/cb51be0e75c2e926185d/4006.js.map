{"version":3,"file":"bundles/cb51be0e75c2e926185d/4006.js","mappings":"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","sources":["webpack://element-web/./node_modules/@vector-im/compound-design-tokens/assets/web/icons/minus.js","webpack://element-web/./node_modules/@vector-im/compound-design-tokens/assets/web/icons/plus.js","webpack://element-web/./src/components/views/location/LocationViewDialog.tsx","webpack://element-web/./src/components/views/location/Map.tsx","webpack://element-web/./src/utils/location/useMap.ts","webpack://element-web/./src/components/views/location/Marker.tsx","webpack://element-web/./src/components/views/location/SmartMarker.tsx","webpack://element-web/./src/components/views/location/ZoomButtons.tsx","webpack://element-web/./src/utils/location/map.ts"],"sourcesContent":["import { forwardRef } from \"react\";\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nfunction MinusIcon(props, ref) {\n  return /*#__PURE__*/_jsx(\"svg\", {\n    xmlns: \"http://www.w3.org/2000/svg\",\n    width: \"1em\",\n    height: \"1em\",\n    fill: \"currentColor\",\n    viewBox: \"0 0 24 24\",\n    ref: ref,\n    ...props,\n    children: /*#__PURE__*/_jsx(\"path\", {\n      d: \"M6 13a.97.97 0 0 1-.713-.287A.97.97 0 0 1 5 12q0-.424.287-.713A.97.97 0 0 1 6 11h12q.424 0 .712.287.288.288.288.713 0 .424-.288.713A.97.97 0 0 1 18 13z\"\n    })\n  });\n}\n;\nMinusIcon.displayName = \"MinusIcon\";\nexport default forwardRef(MinusIcon);","import { forwardRef } from \"react\";\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nfunction PlusIcon(props, ref) {\n  return /*#__PURE__*/_jsx(\"svg\", {\n    xmlns: \"http://www.w3.org/2000/svg\",\n    width: \"1em\",\n    height: \"1em\",\n    fill: \"currentColor\",\n    viewBox: \"0 0 24 24\",\n    ref: ref,\n    ...props,\n    children: /*#__PURE__*/_jsx(\"path\", {\n      d: \"M11 13H6a.97.97 0 0 1-.713-.287A.97.97 0 0 1 5 12q0-.424.287-.713A.97.97 0 0 1 6 11h5V6q0-.424.287-.713A.97.97 0 0 1 12 5q.424 0 .713.287Q13 5.576 13 6v5h5q.424 0 .712.287.288.288.288.713 0 .424-.288.713A.97.97 0 0 1 18 13h-5v5q0 .424-.287.712A.97.97 0 0 1 12 19a.97.97 0 0 1-.713-.288A.97.97 0 0 1 11 18z\"\n    })\n  });\n}\n;\nPlusIcon.displayName = \"PlusIcon\";\nexport default forwardRef(PlusIcon);","/*\r\nCopyright 2024 New Vector Ltd.\r\nCopyright 2022 The Matrix.org Foundation C.I.C.\r\n\r\nSPDX-License-Identifier: AGPL-3.0-only OR GPL-3.0-only OR LicenseRef-Element-Commercial\r\nPlease see LICENSE files in the repository root for full details.\r\n*/\r\n\r\nimport React from \"react\";\r\nimport { type MatrixEvent, type MatrixClient } from \"matrix-js-sdk/src/matrix\";\r\n\r\nimport BaseDialog from \"../dialogs/BaseDialog\";\r\nimport { locationEventGeoUri, isSelfLocation } from \"../../../utils/location\";\r\nimport Map from \"./Map\";\r\nimport SmartMarker from \"./SmartMarker\";\r\nimport ZoomButtons from \"./ZoomButtons\";\r\n\r\ninterface IProps {\r\n    matrixClient: MatrixClient;\r\n    mxEvent: MatrixEvent;\r\n    onFinished(): void;\r\n}\r\n\r\ninterface IState {\r\n    error?: Error;\r\n}\r\n\r\n/**\r\n * Dialog to view m.location events maximised\r\n */\r\nexport default class LocationViewDialog extends React.Component<IProps, IState> {\r\n    public constructor(props: IProps) {\r\n        super(props);\r\n\r\n        this.state = {\r\n            error: undefined,\r\n        };\r\n    }\r\n\r\n    private getBodyId = (): string => {\r\n        return `mx_LocationViewDialog_${this.props.mxEvent.getId()}`;\r\n    };\r\n\r\n    private onError = (error: Error): void => {\r\n        this.setState({ error });\r\n    };\r\n\r\n    public render(): React.ReactNode {\r\n        const { mxEvent } = this.props;\r\n\r\n        // only pass member to marker when should render avatar marker\r\n        const markerRoomMember = (isSelfLocation(mxEvent.getContent()) && mxEvent.sender) || undefined;\r\n        const geoUri = locationEventGeoUri(mxEvent);\r\n        return (\r\n            <BaseDialog className=\"mx_LocationViewDialog\" onFinished={this.props.onFinished} fixedWidth={false}>\r\n                <Map\r\n                    id={this.getBodyId()}\r\n                    centerGeoUri={geoUri}\r\n                    onError={this.onError}\r\n                    interactive\r\n                    className=\"mx_LocationViewDialog_map\"\r\n                    allowGeolocate\r\n                >\r\n                    {({ map }) => (\r\n                        <>\r\n                            <SmartMarker\r\n                                map={map}\r\n                                id={`${this.getBodyId()}-marker`}\r\n                                geoUri={geoUri}\r\n                                roomMember={markerRoomMember}\r\n                            />\r\n                            <ZoomButtons map={map} />\r\n                        </>\r\n                    )}\r\n                </Map>\r\n            </BaseDialog>\r\n        );\r\n    }\r\n}\r\n","/*\r\nCopyright 2024 New Vector Ltd.\r\nCopyright 2022 The Matrix.org Foundation C.I.C.\r\n\r\nSPDX-License-Identifier: AGPL-3.0-only OR GPL-3.0-only OR LicenseRef-Element-Commercial\r\nPlease see LICENSE files in the repository root for full details.\r\n*/\r\n\r\nimport React, { type ReactNode, useContext, useEffect, useState } from \"react\";\r\nimport classNames from \"classnames\";\r\nimport * as maplibregl from \"maplibre-gl\";\r\nimport { ClientEvent, type IClientWellKnown } from \"matrix-js-sdk/src/matrix\";\r\nimport { logger } from \"matrix-js-sdk/src/logger\";\r\n\r\nimport MatrixClientContext from \"../../../contexts/MatrixClientContext\";\r\nimport { useEventEmitterState } from \"../../../hooks/useEventEmitter\";\r\nimport { parseGeoUri, positionFailureMessage } from \"../../../utils/location\";\r\nimport { tileServerFromWellKnown } from \"../../../utils/WellKnownUtils\";\r\nimport { useMap } from \"../../../utils/location/useMap\";\r\nimport { type Bounds } from \"../../../utils/beacon/bounds\";\r\nimport Modal from \"../../../Modal\";\r\nimport ErrorDialog from \"../dialogs/ErrorDialog\";\r\nimport { _t } from \"../../../languageHandler\";\r\n\r\nconst useMapWithStyle = ({\r\n    id,\r\n    centerGeoUri,\r\n    onError,\r\n    interactive,\r\n    bounds,\r\n    allowGeolocate,\r\n}: {\r\n    id: string;\r\n    centerGeoUri?: string;\r\n    onError?(error: Error): void;\r\n    interactive?: boolean;\r\n    bounds?: Bounds;\r\n    allowGeolocate?: boolean;\r\n}): {\r\n    map: maplibregl.Map | undefined;\r\n    bodyId: string;\r\n} => {\r\n    const bodyId = `mx_Map_${id}`;\r\n\r\n    // style config\r\n    const context = useContext(MatrixClientContext);\r\n    const mapStyleUrl = useEventEmitterState(\r\n        context,\r\n        ClientEvent.ClientWellKnown,\r\n        (clientWellKnown: IClientWellKnown) => tileServerFromWellKnown(clientWellKnown)?.[\"map_style_url\"],\r\n    );\r\n\r\n    const map = useMap({ interactive, bodyId, onError });\r\n\r\n    useEffect(() => {\r\n        if (mapStyleUrl && map) {\r\n            map.setStyle(mapStyleUrl);\r\n        }\r\n    }, [mapStyleUrl, map]);\r\n\r\n    useEffect(() => {\r\n        if (map && centerGeoUri) {\r\n            try {\r\n                const coords = parseGeoUri(centerGeoUri);\r\n                if (!coords) {\r\n                    throw new Error(\"Invalid geo URI\");\r\n                }\r\n                map.setCenter({ lon: coords.longitude, lat: coords.latitude });\r\n            } catch (e) {\r\n                logger.error(\"Could not set map center\", e);\r\n            }\r\n        }\r\n    }, [map, centerGeoUri]);\r\n\r\n    useEffect(() => {\r\n        if (map && bounds) {\r\n            try {\r\n                const lngLatBounds = new maplibregl.LngLatBounds(\r\n                    [bounds.west, bounds.south],\r\n                    [bounds.east, bounds.north],\r\n                );\r\n                map.fitBounds(lngLatBounds, { padding: 100, maxZoom: 15 });\r\n            } catch (e) {\r\n                logger.error(\"Invalid map bounds\", e);\r\n            }\r\n        }\r\n    }, [map, bounds]);\r\n\r\n    const [geolocate, setGeolocate] = useState<maplibregl.GeolocateControl | null>(null);\r\n\r\n    useEffect(() => {\r\n        if (!map) {\r\n            return;\r\n        }\r\n        if (allowGeolocate && !geolocate) {\r\n            const geolocate = new maplibregl.GeolocateControl({\r\n                positionOptions: {\r\n                    enableHighAccuracy: true,\r\n                },\r\n                trackUserLocation: false,\r\n            });\r\n            setGeolocate(geolocate);\r\n            map.addControl(geolocate);\r\n        }\r\n        if (!allowGeolocate && geolocate) {\r\n            map.removeControl(geolocate);\r\n            setGeolocate(null);\r\n        }\r\n    }, [map, geolocate, allowGeolocate]);\r\n\r\n    useEffect(() => {\r\n        if (geolocate) {\r\n            geolocate.on(\"error\", onGeolocateError);\r\n            return () => {\r\n                geolocate.off(\"error\", onGeolocateError);\r\n            };\r\n        }\r\n    }, [geolocate]);\r\n\r\n    return {\r\n        map,\r\n        bodyId,\r\n    };\r\n};\r\n\r\nconst onGeolocateError = (e: GeolocationPositionError): void => {\r\n    logger.error(\"Could not fetch location\", e);\r\n    Modal.createDialog(ErrorDialog, {\r\n        title: _t(\"location_sharing|error_fetch_location\"),\r\n        description: positionFailureMessage(e.code) ?? \"\",\r\n    });\r\n};\r\n\r\nexport interface MapProps {\r\n    id: string;\r\n    interactive?: boolean;\r\n    /**\r\n     * set map center to geoUri coords\r\n     * Center will only be set to valid geoUri\r\n     * this prop is only simply diffed by useEffect, so to trigger *recentering* of the same geoUri\r\n     * append the uri with a var not used by the geoUri spec\r\n     * eg a timestamp: `geo:54,42;mxTs=123`\r\n     */\r\n    centerGeoUri?: string;\r\n    bounds?: Bounds;\r\n    className?: string;\r\n    allowGeolocate?: boolean;\r\n    onClick?: () => void;\r\n    onError?: (error: Error) => void;\r\n    children?: (renderProps: { map: maplibregl.Map }) => ReactNode;\r\n}\r\n\r\nconst MapComponent: React.FC<MapProps> = ({\r\n    bounds,\r\n    centerGeoUri,\r\n    children,\r\n    className,\r\n    allowGeolocate,\r\n    id,\r\n    interactive,\r\n    onError,\r\n    onClick,\r\n}) => {\r\n    const { map, bodyId } = useMapWithStyle({ centerGeoUri, onError, id, interactive, bounds, allowGeolocate });\r\n\r\n    const onMapClick = (event: React.MouseEvent<HTMLDivElement, MouseEvent>): void => {\r\n        // Eat click events when clicking the attribution button\r\n        const target = event.target as Element;\r\n        if (target.classList.contains(\"maplibregl-ctrl-attrib-button\")) {\r\n            return;\r\n        }\r\n\r\n        onClick?.();\r\n    };\r\n\r\n    return (\r\n        <div className={classNames(\"mx_Map\", className)} id={bodyId} onClick={onMapClick}>\r\n            {!!children && !!map && children({ map })}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default MapComponent;\r\n","/*\r\nCopyright 2024 New Vector Ltd.\r\nCopyright 2022 The Matrix.org Foundation C.I.C.\r\n\r\nSPDX-License-Identifier: AGPL-3.0-only OR GPL-3.0-only OR LicenseRef-Element-Commercial\r\nPlease see LICENSE files in the repository root for full details.\r\n*/\r\n\r\nimport { useEffect, useState } from \"react\";\r\n\r\nimport type { Map as MapLibreMap } from \"maplibre-gl\";\r\nimport { createMap } from \"./map\";\r\nimport { useMatrixClientContext } from \"../../contexts/MatrixClientContext\";\r\n\r\ninterface UseMapProps {\r\n    bodyId: string;\r\n    onError?: (error: Error) => void;\r\n    interactive?: boolean;\r\n}\r\n\r\n/**\r\n * Create a map instance\r\n * Add listeners for errors\r\n * Make sure `onError` has a stable reference\r\n * As map is recreated on changes to it\r\n */\r\nexport const useMap = ({ interactive, bodyId, onError }: UseMapProps): MapLibreMap | undefined => {\r\n    const cli = useMatrixClientContext();\r\n    const [map, setMap] = useState<MapLibreMap>();\r\n\r\n    useEffect(\r\n        () => {\r\n            let map: MapLibreMap | undefined;\r\n            try {\r\n                map = createMap(cli, !!interactive, bodyId, onError);\r\n                setMap(map);\r\n            } catch (error) {\r\n                console.error(\"Error encountered in useMap\", error);\r\n                if (error instanceof Error) {\r\n                    onError?.(error);\r\n                }\r\n            }\r\n            return () => {\r\n                if (map) {\r\n                    map.remove();\r\n                    setMap(undefined);\r\n                }\r\n            };\r\n        },\r\n        // map is excluded as a dependency\r\n        [cli, interactive, bodyId, onError],\r\n    );\r\n\r\n    return map;\r\n};\r\n","/*\r\nCopyright 2024 New Vector Ltd.\r\nCopyright 2022 The Matrix.org Foundation C.I.C.\r\n\r\nSPDX-License-Identifier: AGPL-3.0-only OR GPL-3.0-only OR LicenseRef-Element-Commercial\r\nPlease see LICENSE files in the repository root for full details.\r\n*/\r\n\r\nimport React, { type JSX, type ReactNode, type Ref, useState } from \"react\";\r\nimport classNames from \"classnames\";\r\nimport { type RoomMember } from \"matrix-js-sdk/src/matrix\";\r\nimport LocationIcon from \"@vector-im/compound-design-tokens/assets/web/icons/location-pin-solid\";\r\n\r\nimport { getUserNameColorClass } from \"../../../utils/FormattingUtils\";\r\nimport MemberAvatar from \"../avatars/MemberAvatar\";\r\n\r\ninterface Props {\r\n    id?: string;\r\n    // renders MemberAvatar when provided\r\n    roomMember?: RoomMember;\r\n    // use member text color as background\r\n    useMemberColor?: boolean;\r\n    tooltip?: ReactNode;\r\n    ref?: Ref<HTMLDivElement>;\r\n}\r\n\r\n/**\r\n * Wrap with tooltip handlers when\r\n * tooltip is truthy\r\n */\r\nconst OptionalTooltip: React.FC<{\r\n    tooltip?: ReactNode;\r\n    children: ReactNode;\r\n}> = ({ tooltip, children }) => {\r\n    const [isVisible, setIsVisible] = useState(false);\r\n    if (!tooltip) {\r\n        return <>{children}</>;\r\n    }\r\n\r\n    const show = (): void => setIsVisible(true);\r\n    const hide = (): void => setIsVisible(false);\r\n    const toggleVisibility = (e: React.MouseEvent<HTMLDivElement, MouseEvent>): void => {\r\n        // stop map from zooming in on click\r\n        e.stopPropagation();\r\n        setIsVisible(!isVisible);\r\n    };\r\n\r\n    return (\r\n        <div onMouseEnter={show} onClick={toggleVisibility} onMouseLeave={hide}>\r\n            {children}\r\n            {isVisible && tooltip}\r\n        </div>\r\n    );\r\n};\r\n\r\n/**\r\n * Generic location marker\r\n */\r\nconst Marker = ({ id, roomMember, useMemberColor, tooltip, ref }: Props): JSX.Element => {\r\n    const memberColorClass = useMemberColor && roomMember ? getUserNameColorClass(roomMember.userId) : \"\";\r\n    return (\r\n        <div\r\n            ref={ref}\r\n            id={id}\r\n            className={classNames(\"mx_Marker\", memberColorClass, {\r\n                mx_Marker_defaultColor: !memberColorClass,\r\n            })}\r\n        >\r\n            <OptionalTooltip tooltip={tooltip}>\r\n                <div className=\"mx_Marker_border\">\r\n                    {roomMember ? (\r\n                        <MemberAvatar\r\n                            member={roomMember}\r\n                            size=\"36px\"\r\n                            viewUserOnClick={false}\r\n                            // no mxid on hover when marker has tooltip\r\n                            hideTitle={!!tooltip}\r\n                        />\r\n                    ) : (\r\n                        <LocationIcon className=\"mx_Marker_icon\" />\r\n                    )}\r\n                </div>\r\n            </OptionalTooltip>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default Marker;\r\n","/*\r\nCopyright 2024 New Vector Ltd.\r\nCopyright 2022 The Matrix.org Foundation C.I.C.\r\n\r\nSPDX-License-Identifier: AGPL-3.0-only OR GPL-3.0-only OR LicenseRef-Element-Commercial\r\nPlease see LICENSE files in the repository root for full details.\r\n*/\r\n\r\nimport React, { type ReactNode, useCallback, useEffect, useState } from \"react\";\r\nimport { type RoomMember } from \"matrix-js-sdk/src/matrix\";\r\n\r\nimport type * as maplibregl from \"maplibre-gl\";\r\nimport { parseGeoUri } from \"../../../utils/location\";\r\nimport { createMarker } from \"../../../utils/location/map\";\r\nimport Marker from \"./Marker\";\r\n\r\nconst useMapMarker = (\r\n    map: maplibregl.Map,\r\n    geoUri: string,\r\n): { marker?: maplibregl.Marker; onElementRef: (el: HTMLDivElement) => void } => {\r\n    const [marker, setMarker] = useState<maplibregl.Marker>();\r\n\r\n    const onElementRef = useCallback(\r\n        (element: HTMLDivElement) => {\r\n            if (marker || !element) {\r\n                return;\r\n            }\r\n            const coords = parseGeoUri(geoUri);\r\n            if (coords) {\r\n                const newMarker = createMarker(coords, element);\r\n                newMarker.addTo(map);\r\n                setMarker(newMarker);\r\n            }\r\n        },\r\n        [marker, geoUri, map],\r\n    );\r\n\r\n    useEffect(() => {\r\n        if (marker) {\r\n            const coords = parseGeoUri(geoUri);\r\n            if (coords) {\r\n                marker.setLngLat({ lon: coords.longitude, lat: coords.latitude });\r\n            }\r\n        }\r\n    }, [marker, geoUri]);\r\n\r\n    useEffect(\r\n        () => () => {\r\n            if (marker) {\r\n                marker.remove();\r\n            }\r\n        },\r\n        [marker],\r\n    );\r\n\r\n    return {\r\n        marker,\r\n        onElementRef,\r\n    };\r\n};\r\n\r\nexport interface SmartMarkerProps {\r\n    map: maplibregl.Map;\r\n    geoUri: string;\r\n    id?: string;\r\n    // renders MemberAvatar when provided\r\n    roomMember?: RoomMember;\r\n    // use member text color as background\r\n    useMemberColor?: boolean;\r\n    tooltip?: ReactNode;\r\n}\r\n\r\n/**\r\n * Generic location marker\r\n */\r\nconst SmartMarker: React.FC<SmartMarkerProps> = ({ id, map, geoUri, roomMember, useMemberColor, tooltip }) => {\r\n    const { onElementRef } = useMapMarker(map, geoUri);\r\n\r\n    return (\r\n        // maplibregl hijacks the Marker dom element\r\n        // and removes it from the dom when the maplibregl.Marker instance\r\n        // is removed\r\n        // wrap in a span so that react doesn't get confused\r\n        // when trying to unmount this component\r\n        <span>\r\n            <Marker\r\n                ref={onElementRef}\r\n                id={id}\r\n                roomMember={roomMember}\r\n                useMemberColor={useMemberColor}\r\n                tooltip={tooltip}\r\n            />\r\n        </span>\r\n    );\r\n};\r\n\r\nexport default SmartMarker;\r\n","/*\r\nCopyright 2024 New Vector Ltd.\r\nCopyright 2022 The Matrix.org Foundation C.I.C.\r\n\r\nSPDX-License-Identifier: AGPL-3.0-only OR GPL-3.0-only OR LicenseRef-Element-Commercial\r\nPlease see LICENSE files in the repository root for full details.\r\n*/\r\n\r\nimport React from \"react\";\r\nimport { PlusIcon, MinusIcon } from \"@vector-im/compound-design-tokens/assets/web/icons\";\r\n\r\nimport type * as maplibregl from \"maplibre-gl\";\r\nimport { _t } from \"../../../languageHandler\";\r\nimport AccessibleButton from \"../elements/AccessibleButton\";\r\n\r\ninterface Props {\r\n    map: maplibregl.Map;\r\n}\r\n\r\nconst ZoomButtons: React.FC<Props> = ({ map }) => {\r\n    const onZoomIn = (): void => {\r\n        map.zoomIn();\r\n    };\r\n\r\n    const onZoomOut = (): void => {\r\n        map.zoomOut();\r\n    };\r\n\r\n    return (\r\n        <div className=\"mx_ZoomButtons\">\r\n            <AccessibleButton\r\n                onClick={onZoomIn}\r\n                data-testid=\"map-zoom-in-button\"\r\n                title={_t(\"action|zoom_in\")}\r\n                className=\"mx_ZoomButtons_button\"\r\n            >\r\n                <PlusIcon className=\"mx_ZoomButtons_icon\" />\r\n            </AccessibleButton>\r\n            <AccessibleButton\r\n                onClick={onZoomOut}\r\n                data-testid=\"map-zoom-out-button\"\r\n                title={_t(\"action|zoom_out\")}\r\n                className=\"mx_ZoomButtons_button\"\r\n            >\r\n                <MinusIcon className=\"mx_ZoomButtons_icon\" />\r\n            </AccessibleButton>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default ZoomButtons;\r\n","/*\r\nCopyright 2024 New Vector Ltd.\r\nCopyright 2022 The Matrix.org Foundation C.I.C.\r\n\r\nSPDX-License-Identifier: AGPL-3.0-only OR GPL-3.0-only OR LicenseRef-Element-Commercial\r\nPlease see LICENSE files in the repository root for full details.\r\n*/\r\n\r\nimport * as maplibregl from \"maplibre-gl\";\r\nimport { type MatrixClient } from \"matrix-js-sdk/src/matrix\";\r\nimport { logger } from \"matrix-js-sdk/src/logger\";\r\n\r\nimport { _t } from \"../../languageHandler\";\r\nimport { findMapStyleUrl } from \"./findMapStyleUrl\";\r\nimport { LocationShareError } from \"./LocationShareErrors\";\r\n\r\nexport const createMap = (\r\n    client: MatrixClient,\r\n    interactive: boolean,\r\n    bodyId: string,\r\n    onError?: (error: Error) => void,\r\n): maplibregl.Map => {\r\n    try {\r\n        const styleUrl = findMapStyleUrl(client);\r\n\r\n        const map = new maplibregl.Map({\r\n            container: bodyId,\r\n            style: styleUrl,\r\n            zoom: 15,\r\n            interactive,\r\n            attributionControl: false,\r\n            locale: {\r\n                \"AttributionControl.ToggleAttribution\": _t(\"location_sharing|toggle_attribution\"),\r\n                \"AttributionControl.MapFeedback\": _t(\"location_sharing|map_feedback\"),\r\n                \"FullscreenControl.Enter\": _t(\"action|enter_fullscreen\"),\r\n                \"FullscreenControl.Exit\": _t(\"action|exit_fullscreeen\"),\r\n                \"GeolocateControl.FindMyLocation\": _t(\"location_sharing|find_my_location\"),\r\n                \"GeolocateControl.LocationNotAvailable\": _t(\"location_sharing|location_not_available\"),\r\n                \"LogoControl.Title\": _t(\"location_sharing|mapbox_logo\"),\r\n                \"NavigationControl.ResetBearing\": _t(\"location_sharing|reset_bearing\"),\r\n                \"NavigationControl.ZoomIn\": _t(\"action|zoom_in\"),\r\n                \"NavigationControl.ZoomOut\": _t(\"action|zoom_out\"),\r\n            },\r\n        });\r\n        map.addControl(new maplibregl.AttributionControl(), \"top-right\");\r\n\r\n        map.on(\"error\", (e) => {\r\n            logger.error(\"Failed to load map: check map_style_url in config.json has a valid URL and API key\", e.error);\r\n            onError?.(new Error(LocationShareError.MapStyleUrlNotReachable));\r\n        });\r\n\r\n        return map;\r\n    } catch (e) {\r\n        logger.error(\"Failed to render map\", e);\r\n        const errorMessage = (e as Error)?.message;\r\n        if (errorMessage.includes(\"Failed to initialize WebGL\")) throw new Error(LocationShareError.WebGLNotEnabled);\r\n        throw e;\r\n    }\r\n};\r\n\r\nexport const createMarker = (coords: GeolocationCoordinates, element: HTMLElement): maplibregl.Marker => {\r\n    const marker = new maplibregl.Marker({\r\n        element,\r\n        anchor: \"bottom\",\r\n        offset: [0, -1],\r\n    }).setLngLat({ lon: coords.longitude, lat: coords.latitude });\r\n    return marker;\r\n};\r\n"],"names":["MinusIcon","props","ref","xmlns","width","height","fill","viewBox","children","d","displayName","forwardRef","PlusIcon","LocationViewDialog","React","constructor","super","_defineProperty","this","mxEvent","getId","error","setState","state","undefined","render","markerRoomMember","isSelfLocation","getContent","sender","geoUri","locationEventGeoUri","BaseDialog","className","onFinished","fixedWidth","Map","id","getBodyId","centerGeoUri","onError","interactive","allowGeolocate","map","SmartMarker","roomMember","ZoomButtons","useMapWithStyle","bounds","bodyId","context","useContext","MatrixClientContext","mapStyleUrl","useEventEmitterState","ClientEvent","ClientWellKnown","clientWellKnown","_tileServerFromWellKn","tileServerFromWellKnown","useMap","cli","useMatrixClientContext","setMap","useState","useEffect","createMap","console","Error","remove","setStyle","coords","parseGeoUri","setCenter","lon","longitude","lat","latitude","e","logger","lngLatBounds","maplibregl","west","south","east","north","fitBounds","padding","maxZoom","geolocate","setGeolocate","positionOptions","enableHighAccuracy","trackUserLocation","addControl","removeControl","on","onGeolocateError","off","_positionFailureMessa","Modal","createDialog","ErrorDialog","title","_t","description","positionFailureMessage","code","MapComponent","onClick","classNames","event","target","classList","contains","OptionalTooltip","tooltip","isVisible","setIsVisible","onMouseEnter","show","stopPropagation","onMouseLeave","hide","Marker","useMemberColor","memberColorClass","getUserNameColorClass","userId","mx_Marker_defaultColor","MemberAvatar","member","size","viewUserOnClick","hideTitle","LocationIcon","onElementRef","useMapMarker","marker","setMarker","useCallback","element","newMarker","createMarker","addTo","setLngLat","AccessibleButton","onZoomIn","zoomIn","onZoomOut","zoomOut","client","styleUrl","findMapStyleUrl","container","style","zoom","attributionControl","locale","LocationShareError","MapStyleUrlNotReachable","message","includes","WebGLNotEnabled","anchor","offset"],"sourceRoot":""}