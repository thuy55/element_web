{"version":3,"file":"bundles/cb51be0e75c2e926185d/2792.js","mappings":"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","sources":["webpack://element-web/./src/effects/snowfall/index.ts"],"sourcesContent":["/*\r\nCopyright 2024 New Vector Ltd.\r\nCopyright 2020-2023 The Matrix.org Foundation C.I.C.\r\n\r\nSPDX-License-Identifier: AGPL-3.0-only OR GPL-3.0-only OR LicenseRef-Element-Commercial\r\nPlease see LICENSE files in the repository root for full details.\r\n */\r\nimport type ICanvasEffect from \"../ICanvasEffect\";\r\nimport { arrayFastClone } from \"../../utils/arrays\";\r\n\r\nexport type SnowfallOptions = {\r\n    /**\r\n     * The maximum number of snowflakes to render at a given time\r\n     */\r\n    maxCount: number;\r\n    /**\r\n     * The amount of gravity to apply to the snowflakes\r\n     */\r\n    gravity: number;\r\n    /**\r\n     * The amount of drift (horizontal sway) to apply to the snowflakes. Each snowflake varies.\r\n     */\r\n    maxDrift: number;\r\n};\r\n\r\ntype Snowflake = {\r\n    x: number;\r\n    y: number;\r\n    xCol: number;\r\n    diameter: number;\r\n    maximumDrift: number;\r\n    gravity: number;\r\n};\r\n\r\nexport const DefaultOptions: SnowfallOptions = {\r\n    maxCount: 200,\r\n    gravity: 0.05,\r\n    maxDrift: 5,\r\n};\r\n\r\nconst KEY_FRAME_INTERVAL = 15; // 15ms, roughly\r\n\r\nexport default class Snowfall implements ICanvasEffect {\r\n    private readonly options: SnowfallOptions;\r\n\r\n    public constructor(options: { [key: string]: any }) {\r\n        this.options = { ...DefaultOptions, ...options };\r\n    }\r\n\r\n    private context: CanvasRenderingContext2D | null = null;\r\n    private particles: Array<Snowflake> = [];\r\n    private lastAnimationTime = 0;\r\n\r\n    public isRunning = false;\r\n\r\n    public start = async (canvas: HTMLCanvasElement, timeout = 3000): Promise<void> => {\r\n        if (!canvas) {\r\n            return;\r\n        }\r\n        this.context = canvas.getContext(\"2d\");\r\n        this.particles = [];\r\n        const count = this.options.maxCount;\r\n        while (this.particles.length < count) {\r\n            this.particles.push(this.resetParticle({} as Snowflake, canvas.width, canvas.height));\r\n        }\r\n        this.isRunning = true;\r\n        requestAnimationFrame(this.renderLoop);\r\n        if (timeout) {\r\n            window.setTimeout(this.stop, timeout);\r\n        }\r\n    };\r\n\r\n    public stop = async (): Promise<void> => {\r\n        this.isRunning = false;\r\n    };\r\n\r\n    private resetParticle = (particle: Snowflake, width: number, height: number): Snowflake => {\r\n        particle.x = Math.random() * width;\r\n        particle.y = Math.random() * -height;\r\n        particle.xCol = particle.x;\r\n        particle.diameter = Math.random() * 7 + 4;\r\n        particle.maximumDrift = Math.random() * this.options.maxDrift + 3.5;\r\n        particle.gravity = this.options.gravity + Math.random() * 6 + 4;\r\n        return particle;\r\n    };\r\n\r\n    private renderLoop = (): void => {\r\n        if (!this.context || !this.context.canvas) {\r\n            return;\r\n        }\r\n        if (this.particles.length === 0) {\r\n            this.context.clearRect(0, 0, this.context.canvas.width, this.context.canvas.height);\r\n        } else {\r\n            const timeDelta = Date.now() - this.lastAnimationTime;\r\n            if (timeDelta >= KEY_FRAME_INTERVAL || !this.lastAnimationTime) {\r\n                // Clear the screen first\r\n                this.context.clearRect(0, 0, this.context.canvas.width, this.context.canvas.height);\r\n\r\n                this.lastAnimationTime = Date.now();\r\n                this.animateAndRenderSnowflakes();\r\n            }\r\n            requestAnimationFrame(this.renderLoop);\r\n        }\r\n    };\r\n\r\n    private animateAndRenderSnowflakes(): void {\r\n        if (!this.context || !this.context.canvas) {\r\n            return;\r\n        }\r\n        const height = this.context.canvas.height;\r\n        for (const particle of arrayFastClone(this.particles)) {\r\n            particle.y += particle.gravity;\r\n\r\n            // We treat the drift as a sine function to have a more fluid-like movement instead\r\n            // of a pong-like movement off walls of the X column. This means that for\r\n            // $x=A\\sin(\\frac{2\\pi}{P}y)$ we use the `maximumDrift` as the amplitude (A) and a\r\n            // large multiplier to create a very long waveform through P.\r\n            const peakDistance = 75 * particle.maximumDrift;\r\n            const PI2 = Math.PI * 2;\r\n            particle.x = particle.maximumDrift * Math.sin((PI2 / peakDistance) * particle.y);\r\n            particle.x += particle.xCol; // bring the particle to the right place\r\n\r\n            const radius = particle.diameter / 2;\r\n            this.context.save();\r\n            this.context.beginPath();\r\n            this.context.ellipse(particle.x, particle.y, radius, radius, 0, 0, 360);\r\n            this.context.fillStyle = \"#eaeaea\"; // grey so it shows up on the light theme\r\n            this.context.fill();\r\n            this.context.closePath();\r\n            this.context.restore();\r\n\r\n            // Remove any dead snowflakes\r\n            const maxBounds = radius * 4; // make sure it's *really* off screen\r\n            if (particle.y > height + maxBounds) {\r\n                const idx = this.particles.indexOf(particle);\r\n                this.particles.splice(idx, 1);\r\n            }\r\n        }\r\n    }\r\n}\r\n"],"names":["DefaultOptions","maxCount","gravity","maxDrift","Snowfall","constructor","options","_defineProperty","async","canvas","timeout","this","context","getContext","particles","count","length","push","resetParticle","width","height","isRunning","requestAnimationFrame","renderLoop","window","setTimeout","stop","particle","x","Math","random","y","xCol","diameter","maximumDrift","clearRect","Date","now","lastAnimationTime","animateAndRenderSnowflakes","_objectSpread","arrayFastClone","peakDistance","PI2","PI","sin","radius","save","beginPath","ellipse","fillStyle","fill","closePath","restore","maxBounds","idx","indexOf","splice"],"sourceRoot":""}