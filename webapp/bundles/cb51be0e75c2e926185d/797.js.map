{"version":3,"file":"bundles/cb51be0e75c2e926185d/797.js","mappings":"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","sources":["webpack://element-web/./src/async-components/views/dialogs/eventindex/ManageEventIndexDialog.tsx"],"sourcesContent":["/*\r\nCopyright 2024 New Vector Ltd.\r\nCopyright 2020, 2021 The Matrix.org Foundation C.I.C.\r\n\r\nSPDX-License-Identifier: AGPL-3.0-only OR GPL-3.0-only OR LicenseRef-Element-Commercial\r\nPlease see LICENSE files in the repository root for full details.\r\n*/\r\n\r\nimport React, { type ChangeEvent } from \"react\";\r\nimport { type Room } from \"matrix-js-sdk/src/matrix\";\r\n\r\nimport { _t } from \"../../../../languageHandler\";\r\nimport SdkConfig from \"../../../../SdkConfig\";\r\nimport SettingsStore from \"../../../../settings/SettingsStore\";\r\nimport Modal from \"../../../../Modal\";\r\nimport { formatBytes, formatCountLong } from \"../../../../utils/FormattingUtils\";\r\nimport EventIndexPeg from \"../../../../indexing/EventIndexPeg\";\r\nimport { SettingLevel } from \"../../../../settings/SettingLevel\";\r\nimport Field from \"../../../../components/views/elements/Field\";\r\nimport BaseDialog from \"../../../../components/views/dialogs/BaseDialog\";\r\nimport DialogButtons from \"../../../../components/views/elements/DialogButtons\";\r\nimport { type IIndexStats } from \"../../../../indexing/BaseEventIndexManager\";\r\n\r\ninterface IProps {\r\n    onFinished(): void;\r\n}\r\n\r\ninterface IState {\r\n    eventIndexSize: number;\r\n    eventCount: number;\r\n    crawlingRoomsCount: number;\r\n    roomCount: number;\r\n    currentRoom: string | null;\r\n    crawlerSleepTime: number;\r\n}\r\n\r\n/*\r\n * Allows the user to introspect the event index state and disable it.\r\n */\r\nexport default class ManageEventIndexDialog extends React.Component<IProps, IState> {\r\n    public constructor(props: IProps) {\r\n        super(props);\r\n\r\n        this.state = {\r\n            eventIndexSize: 0,\r\n            eventCount: 0,\r\n            crawlingRoomsCount: 0,\r\n            roomCount: 0,\r\n            currentRoom: null,\r\n            crawlerSleepTime: SettingsStore.getValueAt(SettingLevel.DEVICE, \"crawlerSleepTime\"),\r\n        };\r\n    }\r\n\r\n    public updateCurrentRoom = async (room: Room): Promise<void> => {\r\n        const eventIndex = EventIndexPeg.get();\r\n        if (!eventIndex) return;\r\n        let stats: IIndexStats | undefined;\r\n\r\n        try {\r\n            stats = await eventIndex.getStats();\r\n        } catch {\r\n            // This call may fail if sporadically, not a huge issue as we will\r\n            // try later again and probably succeed.\r\n            return;\r\n        }\r\n\r\n        let currentRoom: string | null = null;\r\n\r\n        if (room) currentRoom = room.name;\r\n        const roomStats = eventIndex.crawlingRooms();\r\n        const crawlingRoomsCount = roomStats.crawlingRooms.size;\r\n        const roomCount = roomStats.totalRooms.size;\r\n\r\n        this.setState({\r\n            eventIndexSize: stats?.size ?? 0,\r\n            eventCount: stats?.eventCount ?? 0,\r\n            crawlingRoomsCount: crawlingRoomsCount,\r\n            roomCount: roomCount,\r\n            currentRoom: currentRoom,\r\n        });\r\n    };\r\n\r\n    public componentWillUnmount(): void {\r\n        const eventIndex = EventIndexPeg.get();\r\n\r\n        if (eventIndex !== null) {\r\n            eventIndex.removeListener(\"changedCheckpoint\", this.updateCurrentRoom);\r\n        }\r\n    }\r\n\r\n    public async componentDidMount(): Promise<void> {\r\n        let eventIndexSize = 0;\r\n        let crawlingRoomsCount = 0;\r\n        let roomCount = 0;\r\n        let eventCount = 0;\r\n        let currentRoom: string | null = null;\r\n\r\n        const eventIndex = EventIndexPeg.get();\r\n\r\n        if (eventIndex !== null) {\r\n            eventIndex.on(\"changedCheckpoint\", this.updateCurrentRoom);\r\n\r\n            try {\r\n                const stats = await eventIndex.getStats();\r\n                if (stats) {\r\n                    eventIndexSize = stats.size;\r\n                    eventCount = stats.eventCount;\r\n                }\r\n            } catch {\r\n                // This call may fail if sporadically, not a huge issue as we\r\n                // will try later again in the updateCurrentRoom call and\r\n                // probably succeed.\r\n            }\r\n\r\n            const roomStats = eventIndex.crawlingRooms();\r\n            crawlingRoomsCount = roomStats.crawlingRooms.size;\r\n            roomCount = roomStats.totalRooms.size;\r\n\r\n            const room = eventIndex.currentRoom();\r\n            if (room) currentRoom = room.name;\r\n        }\r\n\r\n        this.setState({\r\n            eventIndexSize,\r\n            eventCount,\r\n            crawlingRoomsCount,\r\n            roomCount,\r\n            currentRoom,\r\n        });\r\n    }\r\n\r\n    private onDisable = async (): Promise<void> => {\r\n        const DisableEventIndexDialog = (await import(\"./DisableEventIndexDialog\")).default;\r\n        Modal.createDialog(DisableEventIndexDialog, undefined, undefined, /* priority = */ false, /* static = */ true);\r\n    };\r\n\r\n    private onCrawlerSleepTimeChange = (e: ChangeEvent<HTMLInputElement>): void => {\r\n        this.setState({ crawlerSleepTime: parseInt(e.target.value, 10) });\r\n        SettingsStore.setValue(\"crawlerSleepTime\", null, SettingLevel.DEVICE, e.target.value);\r\n    };\r\n\r\n    public render(): React.ReactNode {\r\n        const brand = SdkConfig.get().brand;\r\n\r\n        let crawlerState;\r\n        if (this.state.currentRoom === null) {\r\n            crawlerState = _t(\"settings|security|message_search_indexing_idle\");\r\n        } else {\r\n            crawlerState = _t(\"settings|security|message_search_indexing\", { currentRoom: this.state.currentRoom });\r\n        }\r\n\r\n        const doneRooms = Math.max(0, this.state.roomCount - this.state.crawlingRoomsCount);\r\n\r\n        const eventIndexingSettings = (\r\n            <div>\r\n                {_t(\"settings|security|message_search_intro\", {\r\n                    brand,\r\n                })}\r\n                <div className=\"mx_SettingsTab_subsectionText\">\r\n                    {crawlerState}\r\n                    <br />\r\n                    {_t(\"settings|security|message_search_space_used\")} {formatBytes(this.state.eventIndexSize, 0)}\r\n                    <br />\r\n                    {_t(\"settings|security|message_search_indexed_messages\")} {formatCountLong(this.state.eventCount)}\r\n                    <br />\r\n                    {_t(\"settings|security|message_search_indexed_rooms\")}{\" \"}\r\n                    {_t(\"settings|security|message_search_room_progress\", {\r\n                        doneRooms: formatCountLong(doneRooms),\r\n                        totalRooms: formatCountLong(this.state.roomCount),\r\n                    })}{\" \"}\r\n                    <br />\r\n                    <Field\r\n                        label={_t(\"settings|security|message_search_sleep_time\")}\r\n                        type=\"number\"\r\n                        value={this.state.crawlerSleepTime.toString()}\r\n                        onChange={this.onCrawlerSleepTimeChange}\r\n                    />\r\n                </div>\r\n            </div>\r\n        );\r\n\r\n        return (\r\n            <BaseDialog\r\n                className=\"mx_ManageEventIndexDialog\"\r\n                onFinished={this.props.onFinished}\r\n                title={_t(\"settings|security|message_search_section\")}\r\n            >\r\n                {eventIndexingSettings}\r\n                <DialogButtons\r\n                    primaryButton={_t(\"action|done\")}\r\n                    onPrimaryButtonClick={this.props.onFinished}\r\n                    primaryButtonClass=\"primary\"\r\n                    cancelButton={_t(\"action|disable\")}\r\n                    onCancel={this.onDisable}\r\n                    cancelButtonClass=\"danger\"\r\n                />\r\n            </BaseDialog>\r\n        );\r\n    }\r\n}\r\n"],"names":["ManageEventIndexDialog","React","constructor","props","super","_defineProperty","async","_stats$size","_stats","_stats$eventCount","_stats2","eventIndex","EventIndexPeg","get","stats","getStats","currentRoom","room","name","roomStats","crawlingRooms","crawlingRoomsCount","size","roomCount","totalRooms","this","setState","eventIndexSize","eventCount","DisableEventIndexDialog","default","Modal","createDialog","undefined","e","crawlerSleepTime","parseInt","target","value","SettingsStore","setValue","SettingLevel","DEVICE","state","getValueAt","componentWillUnmount","removeListener","updateCurrentRoom","componentDidMount","on","render","brand","SdkConfig","crawlerState","_t","doneRooms","Math","max","eventIndexingSettings","className","formatBytes","formatCountLong","Field","label","type","toString","onChange","onCrawlerSleepTimeChange","BaseDialog","onFinished","title","DialogButtons","primaryButton","onPrimaryButtonClick","primaryButtonClass","cancelButton","onCancel","onDisable","cancelButtonClass"],"sourceRoot":""}