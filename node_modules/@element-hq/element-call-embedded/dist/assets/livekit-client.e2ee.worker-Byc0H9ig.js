(function(){"use strict";function R(e,t,n,r){function a(s){return s instanceof n?s:new n(function(d){d(s)})}return new(n||(n=Promise))(function(s,d){function b(m){try{I(r.next(m))}catch(E){d(E)}}function _(m){try{I(r.throw(m))}catch(E){d(E)}}function I(m){m.done?s(m.value):a(m.value).then(b,_)}I((r=r.apply(e,t||[])).next())})}typeof SuppressedError=="function"&&SuppressedError;var q={exports:{}},Se=q.exports,ne;function Ee(){return ne||(ne=1,function(e){(function(t,n){e.exports?e.exports=n():t.log=n()})(Se,function(){var t=function(){},n="undefined",r=typeof window!==n&&typeof window.navigator!==n&&/Trident\/|MSIE /.test(window.navigator.userAgent),a=["trace","debug","info","warn","error"],s={},d=null;function b(g,L){var f=g[L];if(typeof f.bind=="function")return f.bind(g);try{return Function.prototype.bind.call(f,g)}catch{return function(){return Function.prototype.apply.apply(f,[g,arguments])}}}function _(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function I(g){return g==="debug"&&(g="log"),typeof console===n?!1:g==="trace"&&r?_:console[g]!==void 0?b(console,g):console.log!==void 0?b(console,"log"):t}function m(){for(var g=this.getLevel(),L=0;L<a.length;L++){var f=a[L];this[f]=L<g?t:this.methodFactory(f,g,this.name)}if(this.log=this.debug,typeof console===n&&g<this.levels.SILENT)return"No console available for logging"}function E(g){return function(){typeof console!==n&&(m.call(this),this[g].apply(this,arguments))}}function w(g,L,f){return I(g)||E.apply(this,arguments)}function S(g,L){var f=this,x,A,o,i="loglevel";typeof g=="string"?i+=":"+g:typeof g=="symbol"&&(i=void 0);function c(p){var k=(a[p]||"silent").toUpperCase();if(!(typeof window===n||!i)){try{window.localStorage[i]=k;return}catch{}try{window.document.cookie=encodeURIComponent(i)+"="+k+";"}catch{}}}function u(){var p;if(!(typeof window===n||!i)){try{p=window.localStorage[i]}catch{}if(typeof p===n)try{var k=window.document.cookie,T=encodeURIComponent(i),Z=k.indexOf(T+"=");Z!==-1&&(p=/^([^;]+)/.exec(k.slice(Z+T.length+1))[1])}catch{}return f.levels[p]===void 0&&(p=void 0),p}}function l(){if(!(typeof window===n||!i)){try{window.localStorage.removeItem(i)}catch{}try{window.document.cookie=encodeURIComponent(i)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function v(p){var k=p;if(typeof k=="string"&&f.levels[k.toUpperCase()]!==void 0&&(k=f.levels[k.toUpperCase()]),typeof k=="number"&&k>=0&&k<=f.levels.SILENT)return k;throw new TypeError("log.setLevel() called with invalid level: "+p)}f.name=g,f.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},f.methodFactory=L||w,f.getLevel=function(){return o??A??x},f.setLevel=function(p,k){return o=v(p),k!==!1&&c(o),m.call(f)},f.setDefaultLevel=function(p){A=v(p),u()||f.setLevel(p,!1)},f.resetLevel=function(){o=null,l(),m.call(f)},f.enableAll=function(p){f.setLevel(f.levels.TRACE,p)},f.disableAll=function(p){f.setLevel(f.levels.SILENT,p)},f.rebuild=function(){if(d!==f&&(x=v(d.getLevel())),m.call(f),d===f)for(var p in s)s[p].rebuild()},x=v(d?d.getLevel():"WARN");var y=u();y!=null&&(o=v(y)),m.call(f)}d=new S,d.getLogger=function(L){if(typeof L!="symbol"&&typeof L!="string"||L==="")throw new TypeError("You must supply a name when creating a logger.");var f=s[L];return f||(f=s[L]=new S(L,d.methodFactory)),f};var K=typeof window!==n?window.log:void 0;return d.noConflict=function(){return typeof window!==n&&window.log===d&&(window.log=K),d},d.getLoggers=function(){return s},d.default=d,d})}(q)),q.exports}var J=Ee(),$;(function(e){e[e.trace=0]="trace",e[e.debug=1]="debug",e[e.info=2]="info",e[e.warn=3]="warn",e[e.error=4]="error",e[e.silent=5]="silent"})($||($={}));var Q;(function(e){e.Default="livekit",e.Room="livekit-room",e.Participant="livekit-participant",e.Track="livekit-track",e.Publication="livekit-track-publication",e.Engine="livekit-engine",e.Signal="livekit-signal",e.PCManager="livekit-pc-manager",e.PCTransport="livekit-pc-transport",e.E2EE="lk-e2ee"})(Q||(Q={}));let ke=J.getLogger("livekit");Object.values(Q).map(e=>J.getLogger(e)),ke.setDefaultLevel($.info);const h=J.getLogger("lk-e2ee");var Le=Object.defineProperty,Re=(e,t,n)=>t in e?Le(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,re=(e,t,n)=>Re(e,typeof t!="symbol"?t+"":t,n);class Pe{constructor(){re(this,"_locking"),re(this,"_locks"),this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){this._locks+=1;let t;const n=new Promise(a=>t=()=>{this._locks-=1,a()}),r=this._locking.then(()=>t);return this._locking=this._locking.then(()=>n),r}}var D;(function(e){e[e.WAITING=0]="WAITING",e[e.RUNNING=1]="RUNNING",e[e.COMPLETED=2]="COMPLETED"})(D||(D={}));class Ke{constructor(){this.pendingTasks=new Map,this.taskMutex=new Pe,this.nextTaskIndex=0}run(t){return R(this,void 0,void 0,function*(){const n={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:D.WAITING};this.pendingTasks.set(n.id,n);const r=yield this.taskMutex.lock();try{return n.executedAt=Date.now(),n.status=D.RUNNING,yield t()}finally{n.status=D.COMPLETED,this.pendingTasks.delete(n.id),r()}})}flush(){return R(this,void 0,void 0,function*(){return this.run(()=>R(this,void 0,void 0,function*(){}))})}snapshot(){return Array.from(this.pendingTasks.values())}}const U="AES-GCM",Ce=10,H={key:10,delta:3,audio:1,empty:0},ie=12,xe={sharedKey:!1,ratchetSalt:"LKFrameEncryptionKey",ratchetWindowSize:8,failureTolerance:Ce,keyringSize:16};class Ae extends Error{constructor(t,n){super(n||"an error has occured"),this.name="LiveKitError",this.code=t}}var se;(function(e){e[e.NotAllowed=0]="NotAllowed",e[e.ServerUnreachable=1]="ServerUnreachable",e[e.InternalError=2]="InternalError",e[e.Cancelled=3]="Cancelled",e[e.LeaveRequest=4]="LeaveRequest",e[e.Timeout=5]="Timeout"})(se||(se={}));var oe;(function(e){e[e.AlreadyOpened=0]="AlreadyOpened",e[e.AbnormalEnd=1]="AbnormalEnd",e[e.DecodeFailed=2]="DecodeFailed",e[e.LengthExceeded=3]="LengthExceeded",e[e.Incomplete=4]="Incomplete",e[e.HandlerAlreadyRegistered=7]="HandlerAlreadyRegistered"})(oe||(oe={}));var j;(function(e){e.PermissionDenied="PermissionDenied",e.NotFound="NotFound",e.DeviceInUse="DeviceInUse",e.Other="Other"})(j||(j={})),function(e){function t(n){if(n&&"name"in n)return n.name==="NotFoundError"||n.name==="DevicesNotFoundError"?e.NotFound:n.name==="NotAllowedError"||n.name==="PermissionDeniedError"?e.PermissionDenied:n.name==="NotReadableError"||n.name==="TrackStartError"?e.DeviceInUse:e.Other}e.getFailure=t}(j||(j={}));var C;(function(e){e[e.InvalidKey=0]="InvalidKey",e[e.MissingKey=1]="MissingKey",e[e.InternalError=2]="InternalError"})(C||(C={}));class O extends Ae{constructor(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:C.InternalError,r=arguments.length>2?arguments[2]:void 0;super(40,t),this.reason=n,this.participantIdentity=r}}var ae;(function(e){e.SetKey="setKey",e.RatchetRequest="ratchetRequest",e.KeyRatcheted="keyRatcheted"})(ae||(ae={}));var W;(function(e){e.KeyRatcheted="keyRatcheted"})(W||(W={}));var ce;(function(e){e.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",e.EncryptionError="encryptionError"})(ce||(ce={}));var M;(function(e){e.Error="cryptorError"})(M||(M={}));var V={exports:{}},ue;function Oe(){if(ue)return V.exports;ue=1;var e=typeof Reflect=="object"?Reflect:null,t=e&&typeof e.apply=="function"?e.apply:function(i,c,u){return Function.prototype.apply.call(i,c,u)},n;e&&typeof e.ownKeys=="function"?n=e.ownKeys:Object.getOwnPropertySymbols?n=function(i){return Object.getOwnPropertyNames(i).concat(Object.getOwnPropertySymbols(i))}:n=function(i){return Object.getOwnPropertyNames(i)};function r(o){console&&console.warn&&console.warn(o)}var a=Number.isNaN||function(i){return i!==i};function s(){s.init.call(this)}V.exports=s,V.exports.once=f,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var d=10;function b(o){if(typeof o!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof o)}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return d},set:function(o){if(typeof o!="number"||o<0||a(o))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+o+".");d=o}}),s.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(i){if(typeof i!="number"||i<0||a(i))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+i+".");return this._maxListeners=i,this};function _(o){return o._maxListeners===void 0?s.defaultMaxListeners:o._maxListeners}s.prototype.getMaxListeners=function(){return _(this)},s.prototype.emit=function(i){for(var c=[],u=1;u<arguments.length;u++)c.push(arguments[u]);var l=i==="error",v=this._events;if(v!==void 0)l=l&&v.error===void 0;else if(!l)return!1;if(l){var y;if(c.length>0&&(y=c[0]),y instanceof Error)throw y;var p=new Error("Unhandled error."+(y?" ("+y.message+")":""));throw p.context=y,p}var k=v[i];if(k===void 0)return!1;if(typeof k=="function")t(k,this,c);else for(var T=k.length,Z=K(k,T),u=0;u<T;++u)t(Z[u],this,c);return!0};function I(o,i,c,u){var l,v,y;if(b(c),v=o._events,v===void 0?(v=o._events=Object.create(null),o._eventsCount=0):(v.newListener!==void 0&&(o.emit("newListener",i,c.listener?c.listener:c),v=o._events),y=v[i]),y===void 0)y=v[i]=c,++o._eventsCount;else if(typeof y=="function"?y=v[i]=u?[c,y]:[y,c]:u?y.unshift(c):y.push(c),l=_(o),l>0&&y.length>l&&!y.warned){y.warned=!0;var p=new Error("Possible EventEmitter memory leak detected. "+y.length+" "+String(i)+" listeners added. Use emitter.setMaxListeners() to increase limit");p.name="MaxListenersExceededWarning",p.emitter=o,p.type=i,p.count=y.length,r(p)}return o}s.prototype.addListener=function(i,c){return I(this,i,c,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(i,c){return I(this,i,c,!0)};function m(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function E(o,i,c){var u={fired:!1,wrapFn:void 0,target:o,type:i,listener:c},l=m.bind(u);return l.listener=c,u.wrapFn=l,l}s.prototype.once=function(i,c){return b(c),this.on(i,E(this,i,c)),this},s.prototype.prependOnceListener=function(i,c){return b(c),this.prependListener(i,E(this,i,c)),this},s.prototype.removeListener=function(i,c){var u,l,v,y,p;if(b(c),l=this._events,l===void 0)return this;if(u=l[i],u===void 0)return this;if(u===c||u.listener===c)--this._eventsCount===0?this._events=Object.create(null):(delete l[i],l.removeListener&&this.emit("removeListener",i,u.listener||c));else if(typeof u!="function"){for(v=-1,y=u.length-1;y>=0;y--)if(u[y]===c||u[y].listener===c){p=u[y].listener,v=y;break}if(v<0)return this;v===0?u.shift():g(u,v),u.length===1&&(l[i]=u[0]),l.removeListener!==void 0&&this.emit("removeListener",i,p||c)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(i){var c,u,l;if(u=this._events,u===void 0)return this;if(u.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):u[i]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete u[i]),this;if(arguments.length===0){var v=Object.keys(u),y;for(l=0;l<v.length;++l)y=v[l],y!=="removeListener"&&this.removeAllListeners(y);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(c=u[i],typeof c=="function")this.removeListener(i,c);else if(c!==void 0)for(l=c.length-1;l>=0;l--)this.removeListener(i,c[l]);return this};function w(o,i,c){var u=o._events;if(u===void 0)return[];var l=u[i];return l===void 0?[]:typeof l=="function"?c?[l.listener||l]:[l]:c?L(l):K(l,l.length)}s.prototype.listeners=function(i){return w(this,i,!0)},s.prototype.rawListeners=function(i){return w(this,i,!1)},s.listenerCount=function(o,i){return typeof o.listenerCount=="function"?o.listenerCount(i):S.call(o,i)},s.prototype.listenerCount=S;function S(o){var i=this._events;if(i!==void 0){var c=i[o];if(typeof c=="function")return 1;if(c!==void 0)return c.length}return 0}s.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]};function K(o,i){for(var c=new Array(i),u=0;u<i;++u)c[u]=o[u];return c}function g(o,i){for(;i+1<o.length;i++)o[i]=o[i+1];o.pop()}function L(o){for(var i=new Array(o.length),c=0;c<i.length;++c)i[c]=o[c].listener||o[c];return i}function f(o,i){return new Promise(function(c,u){function l(y){o.removeListener(i,v),u(y)}function v(){typeof o.removeListener=="function"&&o.removeListener("error",l),c([].slice.call(arguments))}A(o,i,v,{once:!0}),i!=="error"&&x(o,l,{once:!0})})}function x(o,i,c){typeof o.on=="function"&&A(o,"error",i,c)}function A(o,i,c,u){if(typeof o.on=="function")u.once?o.once(i,c):o.on(i,c);else if(typeof o.addEventListener=="function")o.addEventListener(i,function l(v){u.once&&o.removeEventListener(i,l),c(v)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof o)}return V.exports}var de=Oe();function Me(e){return"type"in e}function Te(e){return R(this,arguments,void 0,function(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{name:U},r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"encrypt";return function*(){return crypto.subtle.importKey("raw",t,n,!1,r==="derive"?["deriveBits","deriveKey"]:["encrypt","decrypt"])}()})}function le(e,t){const r=new TextEncoder().encode(t);switch(e){case"HKDF":return{name:"HKDF",salt:r,hash:"SHA-256",info:new ArrayBuffer(128)};case"PBKDF2":return{name:"PBKDF2",salt:r,hash:"SHA-256",iterations:1e5};default:throw new Error("algorithm ".concat(e," is currently unsupported"))}}function fe(e,t){return R(this,void 0,void 0,function*(){const n=le(e.algorithm.name,t),r=yield crypto.subtle.deriveKey(n,e,{name:U,length:128},!1,["encrypt","decrypt"]);return{material:e,encryptionKey:r}})}function De(e,t){return R(this,void 0,void 0,function*(){const n=le(e.algorithm.name,t);return crypto.subtle.deriveBits(n,e,256)})}function Fe(e){for(var t=0;t<e.length-3;t++)if(e[t]==0&&e[t+1]==0&&e[t+2]==3)return!0;return!1}function Be(e){const t=[];for(var n=e.length,r=0;r<e.length;)n-r>=3&&!e[r]&&!e[r+1]&&e[r+2]==3?(t.push(e[r++]),t.push(e[r++]),r++):t.push(e[r++]);return new Uint8Array(t)}const Ne=2,he=3;function qe(e){const t=[];for(var n=0,r=0;r<e.length;++r){var a=e[r];a<=he&&n>=Ne&&(t.push(he),n=0),t.push(a),a==0?++n:n=0}return new Uint8Array(t)}const Ue=31;var X;(function(e){e[e.SLICE_NON_IDR=1]="SLICE_NON_IDR",e[e.SLICE_PARTITION_A=2]="SLICE_PARTITION_A",e[e.SLICE_PARTITION_B=3]="SLICE_PARTITION_B",e[e.SLICE_PARTITION_C=4]="SLICE_PARTITION_C",e[e.SLICE_IDR=5]="SLICE_IDR",e[e.SEI=6]="SEI",e[e.SPS=7]="SPS",e[e.PPS=8]="PPS",e[e.AUD=9]="AUD",e[e.END_SEQ=10]="END_SEQ",e[e.END_STREAM=11]="END_STREAM",e[e.FILLER_DATA=12]="FILLER_DATA",e[e.SPS_EXT=13]="SPS_EXT",e[e.PREFIX_NALU=14]="PREFIX_NALU",e[e.SUBSET_SPS=15]="SUBSET_SPS",e[e.DPS=16]="DPS",e[e.SLICE_AUX=19]="SLICE_AUX",e[e.SLICE_EXT=20]="SLICE_EXT",e[e.SLICE_LAYER_EXT=21]="SLICE_LAYER_EXT"})(X||(X={}));var P;(function(e){e[e.TRAIL_N=0]="TRAIL_N",e[e.TRAIL_R=1]="TRAIL_R",e[e.TSA_N=2]="TSA_N",e[e.TSA_R=3]="TSA_R",e[e.STSA_N=4]="STSA_N",e[e.STSA_R=5]="STSA_R",e[e.RADL_N=6]="RADL_N",e[e.RADL_R=7]="RADL_R",e[e.RASL_N=8]="RASL_N",e[e.RASL_R=9]="RASL_R",e[e.BLA_W_LP=16]="BLA_W_LP",e[e.BLA_W_RADL=17]="BLA_W_RADL",e[e.BLA_N_LP=18]="BLA_N_LP",e[e.IDR_W_RADL=19]="IDR_W_RADL",e[e.IDR_N_LP=20]="IDR_N_LP",e[e.CRA_NUT=21]="CRA_NUT",e[e.VPS_NUT=32]="VPS_NUT",e[e.SPS_NUT=33]="SPS_NUT",e[e.PPS_NUT=34]="PPS_NUT",e[e.AUD_NUT=35]="AUD_NUT",e[e.EOS_NUT=36]="EOS_NUT",e[e.EOB_NUT=37]="EOB_NUT",e[e.FD_NUT=38]="FD_NUT",e[e.PREFIX_SEI_NUT=39]="PREFIX_SEI_NUT",e[e.SUFFIX_SEI_NUT=40]="SUFFIX_SEI_NUT"})(P||(P={}));function ye(e){return e&Ue}function pe(e){return e>>1&63}function ge(e){return e===X.SLICE_IDR||e===X.SLICE_NON_IDR}function ve(e){return e===P.TRAIL_N||e===P.TRAIL_R||e===P.TSA_N||e===P.TSA_R||e===P.STSA_N||e===P.STSA_R||e===P.RADL_N||e===P.RADL_R||e===P.RASL_N||e===P.RASL_R||e===P.BLA_W_LP||e===P.BLA_W_RADL||e===P.BLA_N_LP||e===P.IDR_W_RADL||e===P.IDR_N_LP||e===P.CRA_NUT}function je(e,t){for(const n of t){if(ge(ye(e[n])))return"h264";if(ve(pe(e[n])))return"h265"}return"unknown"}function We(e,t,n){for(const r of t)if(n==="h265"){const a=pe(e[r]);if(ve(a))return r+2}else{const a=ye(e[r]);if(ge(a))return r+2}return null}function Ve(e){const t=[];let n=0,r=0,a=e.length-3;for(;r<a;){for(;r<a&&!(r<a-1&&e[r]===0&&e[r+1]===0&&e[r+2]===0&&e[r+3]===1||e[r]===0&&e[r+1]===0&&e[r+2]===1);)r++;r>=a&&(r=e.length);let s=r;for(;s>n&&e[s-1]===0;)s--;if(n===0){if(s!==n)throw TypeError("byte stream contains leading data")}else t.push(n);let d=3;r<e.length-3&&e[r]===0&&e[r+1]===0&&e[r+2]===0&&e[r+3]===1&&(d=4),n=r=r+d}return t}function Xe(e,t){const n=Ve(e),r=t??je(e,n);if(r==="unknown")return{unencryptedBytes:0,detectedCodec:r,requiresNALUProcessing:!1};const a=We(e,n,r);if(a===null)throw new TypeError("Could not find NALU");return{unencryptedBytes:a,detectedCodec:r,requiresNALUProcessing:!0}}function ze(e){return R(this,void 0,void 0,function*(){const t=yield crypto.subtle.digest("SHA-256",e),n=new Uint8Array(t);return Array.from(n).map(r=>r.toString(16).padStart(2,"0")).join("")})}const F={VP8KeyFrame8x8:"ef0161653d8b2b23aad46624b420af1d03ce48950e9fc85718028f91b50f9219",H264KeyFrame2x2SPS:"f0a0e09647d891d6d50aa898bce7108090375d0d55e50a2bb21147afee558e44",H264KeyFrame2x2PPS:"61d9665eed71b6d424ae9539330a3bdd5cb386d4d781c808219a6e36750493a7",H264KeyFrame2x2IDR:"faffc26b68a2fc09096fa20f3351e706398b6f838a7500c8063472c2e476e90d",OpusSilenceFrame:"aad8d31fc56b2802ca500e58c2fb9d0b29ad71bb7cb52cd6530251eade188988"};function Ge(e){return R(this,void 0,void 0,function*(){switch(yield ze(e)){case F.VP8KeyFrame8x8:return"vp8";case F.H264KeyFrame2x2SPS:return"h264";case F.H264KeyFrame2x2PPS:return"h264";case F.H264KeyFrame2x2IDR:return"h264";case F.OpusSilenceFrame:return"opus";default:return null}})}const we=new Map;class Ye extends de.EventEmitter{encodeFunction(t,n){throw Error("not implemented for subclass")}decodeFunction(t,n){throw Error("not implemented for subclass")}}class Ze extends Ye{constructor(t){var n;super(),this.isTransformActive=!1,this.sendCounts=new Map,this.keys=t.keys,this.participantIdentity=t.participantIdentity,this.rtpMap=new Map,this.keyProviderOptions=t.keyProviderOptions,this.sifTrailer=(n=t.sifTrailer)!==null&&n!==void 0?n:Uint8Array.from([])}get logContext(){return{participant:this.participantIdentity,mediaTrackId:this.trackId,fallbackCodec:this.videoCodec}}setParticipant(t,n){h.debug("setting new participant on cryptor",Object.assign(Object.assign({},this.logContext),{participant:t})),this.participantIdentity&&h.error("cryptor has already a participant set, participant should have been unset before",Object.assign({},this.logContext)),this.participantIdentity=t,this.keys=n}unsetParticipant(){h.debug("unsetting participant",this.logContext),this.participantIdentity=void 0}isEnabled(){if(this.participantIdentity)return we.get(this.participantIdentity)}getParticipantIdentity(){return this.participantIdentity}getTrackId(){return this.trackId}setVideoCodec(t){this.videoCodec=t}setRtpMap(t){this.rtpMap=t}setupTransform(t,n,r,a,s,d){if(d&&(h.info("setting codec on cryptor to",{codec:d}),this.videoCodec=d),h.debug("Setting up frame cryptor transform",Object.assign({operation:t,passedTrackId:a,codec:d},this.logContext)),s&&this.isTransformActive){h.debug("reuse transform",Object.assign({},this.logContext));return}const b=t==="encode"?this.encodeFunction:this.decodeFunction,_=new TransformStream({transform:b.bind(this)});this.isTransformActive=!0,n.pipeThrough(_).pipeTo(r).catch(I=>{h.warn(I),this.emit(M.Error,I instanceof O?I:new O(I.message,void 0,this.participantIdentity))}).finally(()=>{this.isTransformActive=!1}),this.trackId=a}setSifTrailer(t){h.debug("setting SIF trailer",Object.assign(Object.assign({},this.logContext),{trailer:t})),this.sifTrailer=t}encodeFunction(t,n){return R(this,void 0,void 0,function*(){var r;if(!this.isEnabled()||t.data.byteLength===0)return n.enqueue(t);const a=this.keys.getKeySet();if(!a){this.emit(M.Error,new O("key set not found for ".concat(this.participantIdentity," at index ").concat(this.keys.getCurrentKeyIndex()),C.MissingKey,this.participantIdentity));return}const{encryptionKey:s}=a,d=this.keys.getCurrentKeyIndex();if(s){const _=this.makeIV((r=t.getMetadata().synchronizationSource)!==null&&r!==void 0?r:-1,t.timestamp);let I=this.getUnencryptedBytes(t);const m=new Uint8Array(t.data,0,I.unencryptedBytes),E=new Uint8Array(2);E[0]=ie,E[1]=d;try{const w=yield crypto.subtle.encrypt({name:U,iv:_,additionalData:new Uint8Array(t.data,0,m.byteLength)},s,new Uint8Array(t.data,I.unencryptedBytes));let S=new Uint8Array(w.byteLength+_.byteLength+E.byteLength);S.set(new Uint8Array(w)),S.set(new Uint8Array(_),w.byteLength),S.set(E,w.byteLength+_.byteLength),I.requiresNALUProcessing&&(S=qe(S));var b=new Uint8Array(m.byteLength+S.byteLength);return b.set(m),b.set(S,m.byteLength),t.data=b.buffer,n.enqueue(t)}catch(w){h.error(w)}}else h.debug("failed to encrypt, emitting error",this.logContext),this.emit(M.Error,new O("encryption key missing for encoding",C.MissingKey,this.participantIdentity))})}decodeFunction(t,n){return R(this,void 0,void 0,function*(){if(!this.isEnabled()||t.data.byteLength===0)return n.enqueue(t);if(Je(t.data,this.sifTrailer)){if(t.data=t.data.slice(0,t.data.byteLength-this.sifTrailer.byteLength),yield Ge(t.data))return h.debug("enqueue SIF",this.logContext),n.enqueue(t);h.warn("Unexpected SIF frame payload, dropping frame",this.logContext);return}const a=new Uint8Array(t.data)[t.data.byteLength-1];if(!this.keys.hasInvalidKeyAtIndex(a))if(this.keys.getKeySet(a))try{const s=yield this.decryptFrame(t,a);if(this.keys.decryptionSuccess(a),s)return n.enqueue(s)}catch(s){s instanceof O&&s.reason===C.InvalidKey?this.keys.hasValidKey&&(this.emit(M.Error,s),this.keys.decryptionFailure(a)):h.warn("decoding frame failed",{error:s})}else h.warn("skipping decryption due to missing key at index ".concat(a)),this.emit(M.Error,new O("missing key at index ".concat(a," for participant ").concat(this.participantIdentity),C.MissingKey,this.participantIdentity)),this.keys.decryptionFailure(a)})}decryptFrame(t,n){return R(this,arguments,void 0,function(r,a){var s=this;let d=arguments.length>2&&arguments[2]!==void 0?arguments[2]:void 0,b=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{ratchetCount:0};return function*(){var _;const I=s.keys.getKeySet(a);if(!b.encryptionKey&&!I)throw new TypeError("no encryption key found for decryption of ".concat(s.participantIdentity));let m=s.getUnencryptedBytes(r);try{const w=new Uint8Array(r.data,0,m.unencryptedBytes);var E=new Uint8Array(r.data,w.length,r.data.byteLength-w.length);if(m.requiresNALUProcessing&&Fe(E)){E=Be(E);const i=new Uint8Array(w.byteLength+E.byteLength);i.set(w),i.set(E,w.byteLength),r.data=i.buffer}const S=new Uint8Array(r.data,r.data.byteLength-2,2),K=S[0],g=new Uint8Array(r.data,r.data.byteLength-K-S.byteLength,K),L=w.byteLength,f=r.data.byteLength-(w.byteLength+K+S.byteLength),x=yield crypto.subtle.decrypt({name:U,iv:g,additionalData:new Uint8Array(r.data,0,w.byteLength)},(_=b.encryptionKey)!==null&&_!==void 0?_:I.encryptionKey,new Uint8Array(r.data,L,f)),A=new ArrayBuffer(w.byteLength+x.byteLength),o=new Uint8Array(A);return o.set(new Uint8Array(r.data,0,w.byteLength)),o.set(new Uint8Array(x),w.byteLength),r.data=A,r}catch(w){if(s.keyProviderOptions.ratchetWindowSize>0)if(b.ratchetCount<s.keyProviderOptions.ratchetWindowSize){h.debug("ratcheting key attempt ".concat(b.ratchetCount," of ").concat(s.keyProviderOptions.ratchetWindowSize,", for kind ").concat(r instanceof RTCEncodedAudioFrame?"audio":"video"));let S,K;(d??I)===s.keys.getKeySet(a)&&(K=yield s.keys.ratchetKey(a,!1),S=yield fe(K.cryptoKey,s.keyProviderOptions.ratchetSalt));const g=yield s.decryptFrame(r,a,d||I,{ratchetCount:b.ratchetCount+1,encryptionKey:S?.encryptionKey});return g&&S&&(d??I)===s.keys.getKeySet(a)&&(s.keys.setKeySet(S,a,K),s.keys.setCurrentKeyIndex(a)),g}else throw h.warn("maximum ratchet attempts exceeded"),new O("valid key missing for participant ".concat(s.participantIdentity),C.InvalidKey,s.participantIdentity);else throw new O("Decryption failed: ".concat(w.message),C.InvalidKey,s.participantIdentity)}}()})}makeIV(t,n){var r;const a=new ArrayBuffer(ie),s=new DataView(a);this.sendCounts.has(t)||this.sendCounts.set(t,Math.floor(Math.random()*65535));const d=(r=this.sendCounts.get(t))!==null&&r!==void 0?r:0;return s.setUint32(0,t),s.setUint32(4,n),s.setUint32(8,n-d%65535),this.sendCounts.set(t,d+1),a}getUnencryptedBytes(t){var n;if(!Me(t))return{unencryptedBytes:H.audio,requiresNALUProcessing:!1};const r=(n=this.getVideoCodec(t))!==null&&n!==void 0?n:this.videoCodec;if(r!==this.detectedCodec&&(h.debug("detected different codec",Object.assign({detectedCodec:r,oldCodec:this.detectedCodec},this.logContext)),this.detectedCodec=r),r==="av1")throw new Error("".concat(r," is not yet supported for end to end encryption"));if(r==="vp8")return{unencryptedBytes:H[t.type],requiresNALUProcessing:!1};if(r==="vp9")return{unencryptedBytes:0,requiresNALUProcessing:!1};try{const a=r==="h264"||r==="h265"?r:void 0,s=Xe(new Uint8Array(t.data),a);if(s.requiresNALUProcessing)return{unencryptedBytes:s.unencryptedBytes,requiresNALUProcessing:!0}}catch(a){h.debug("NALU processing failed, falling back to VP8 handling",Object.assign({error:a},this.logContext))}return{unencryptedBytes:H[t.type],requiresNALUProcessing:!1}}getVideoCodec(t){if(this.rtpMap.size===0)return;const n=t.getMetadata().payloadType;return n?this.rtpMap.get(n):void 0}}function Je(e,t){if(t.byteLength===0)return!1;const n=new Uint8Array(e.slice(e.byteLength-t.byteLength));return t.every((r,a)=>r===n[a])}class _e extends de.EventEmitter{get hasValidKey(){return!this.hasInvalidKeyAtIndex(this.currentKeyIndex)}constructor(t,n){if(super(),this.currentKeyIndex=0,n.keyringSize<1||n.keyringSize>256)throw new TypeError("Keyring size needs to be between 1 and 256");this.cryptoKeyRing=new Array(n.keyringSize).fill(void 0),this.decryptionFailureCounts=new Array(n.keyringSize).fill(0),this.keyProviderOptions=n,this.ratchetPromiseMap=new Map,this.participantIdentity=t}hasInvalidKeyAtIndex(t){return this.keyProviderOptions.failureTolerance>=0&&this.decryptionFailureCounts[t]>this.keyProviderOptions.failureTolerance}decryptionFailure(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.currentKeyIndex;this.keyProviderOptions.failureTolerance<0||(this.decryptionFailureCounts[t]+=1,this.decryptionFailureCounts[t]>this.keyProviderOptions.failureTolerance&&h.warn("key for ".concat(this.participantIdentity," at index ").concat(t," is being marked as invalid")))}decryptionSuccess(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.currentKeyIndex;this.resetKeyStatus(t)}resetKeyStatus(t){t===void 0?this.decryptionFailureCounts.fill(0):this.decryptionFailureCounts[t]=0}ratchetKey(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;const r=t??this.getCurrentKeyIndex(),a=this.ratchetPromiseMap.get(r);if(typeof a<"u")return a;const s=new Promise((d,b)=>R(this,void 0,void 0,function*(){try{const _=this.getKeySet(r);if(!_)throw new TypeError("Cannot ratchet key without a valid keyset of participant ".concat(this.participantIdentity));const I=_.material,m=yield De(I,this.keyProviderOptions.ratchetSalt),E=yield Te(m,I.algorithm.name,"derive"),w={chainKey:m,cryptoKey:E};n&&(yield this.setKeyFromMaterial(E,r,w)),d(w)}catch(_){b(_)}finally{this.ratchetPromiseMap.delete(r)}}));return this.ratchetPromiseMap.set(r,s),s}setKey(t){return R(this,arguments,void 0,function(n){var r=this;let a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return function*(){yield r.setKeyFromMaterial(n,a),r.resetKeyStatus(a)}()})}setKeyFromMaterial(t,n){return R(this,arguments,void 0,function(r,a){var s=this;let d=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null;return function*(){const b=yield fe(r,s.keyProviderOptions.ratchetSalt),_=a>=0?a%s.cryptoKeyRing.length:s.currentKeyIndex;h.debug("setting new key with index ".concat(a),{usage:r.usages,algorithm:r.algorithm,ratchetSalt:s.keyProviderOptions.ratchetSalt}),s.setKeySet(b,_,d),_>=0&&(s.currentKeyIndex=_)}()})}setKeySet(t,n){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null;this.cryptoKeyRing[n%this.cryptoKeyRing.length]=t,r&&this.emit(W.KeyRatcheted,r,this.participantIdentity,n)}setCurrentKeyIndex(t){return R(this,void 0,void 0,function*(){this.currentKeyIndex=t%this.cryptoKeyRing.length,this.resetKeyStatus(t)})}getCurrentKeyIndex(){return this.currentKeyIndex}getKeySet(t){return this.cryptoKeyRing[t??this.currentKeyIndex]}}const B=[],Ie=new Map;let ee,$e=new Ke,Qe=!1,z=!1,me,N=xe,be=new Map;h.setDefaultLevel("info"),onmessage=e=>{$e.run(()=>R(void 0,void 0,void 0,function*(){const{kind:t,data:n}=e.data;switch(t){case"init":h.setLevel(n.loglevel),h.info("worker initialized"),N=n.keyProviderOptions,z=!!n.keyProviderOptions.sharedKey,postMessage({kind:"initAck",data:{enabled:Qe}});break;case"enable":tt(n.enabled,n.participantIdentity),h.info("updated e2ee enabled status for ".concat(n.participantIdentity," to ").concat(n.enabled)),postMessage(e.data);break;case"decode":G(n.participantIdentity,n.trackId).setupTransform(t,n.readableStream,n.writableStream,n.trackId,n.isReuse,n.codec);break;case"encode":G(n.participantIdentity,n.trackId).setupTransform(t,n.readableStream,n.writableStream,n.trackId,n.isReuse,n.codec);break;case"setKey":z?yield nt(n.key,n.keyIndex):n.participantIdentity?(h.info("set participant sender key ".concat(n.participantIdentity," index ").concat(n.keyIndex)),yield Y(n.participantIdentity).setKey(n.key,n.keyIndex)):h.error("no participant Id was provided and shared key usage is disabled");break;case"removeTransform":et(n.trackId,n.participantIdentity);break;case"updateCodec":G(n.participantIdentity,n.trackId).setVideoCodec(n.codec),h.info("updated codec",{participantIdentity:n.participantIdentity,trackId:n.trackId,codec:n.codec});break;case"setRTPMap":be=n.map,B.forEach(d=>{d.getParticipantIdentity()===n.participantIdentity&&d.setRtpMap(n.map)});break;case"ratchetRequest":He(n);break;case"setSifTrailer":st(n.trailer);break}}))};function He(e){return R(this,void 0,void 0,function*(){if(z){const t=te();yield t.ratchetKey(e.keyIndex),t.resetKeyStatus()}else if(e.participantIdentity){const t=Y(e.participantIdentity);yield t.ratchetKey(e.keyIndex),t.resetKeyStatus()}else h.error("no participant Id was provided for ratchet request and shared key usage is disabled")})}function G(e,t){let n=B.filter(a=>a.getTrackId()===t);if(n.length>1){const a=n.map(s=>({participant:s.getParticipantIdentity()})).join(",");h.error("Found multiple cryptors for the same trackID ".concat(t,". target participant: ").concat(e," "),{participants:a})}let r=n[0];if(r)e!==r.getParticipantIdentity()&&r.setParticipant(e,Y(e));else{if(h.info("creating new cryptor for",{participantIdentity:e,trackId:t}),!N)throw Error("Missing keyProvider options");r=new Ze({participantIdentity:e,keys:Y(e),keyProviderOptions:N,sifTrailer:me}),r.setRtpMap(be),rt(r),B.push(r)}return r}function Y(e){if(z)return te();let t=Ie.get(e);return t||(t=new _e(e,N),t.on(W.KeyRatcheted,it),Ie.set(e,t)),t}function te(){return ee||(h.debug("creating new shared key handler"),ee=new _e("shared-key",N)),ee}function et(e,t){const n=B.filter(a=>a.getParticipantIdentity()===t&&a.getTrackId()===e);n.length>1&&h.error("Found multiple cryptors for the same participant and trackID combination",{trackId:e,participantIdentity:t});const r=n[0];r?r.unsetParticipant():h.warn("Could not unset participant on cryptor",{trackId:e,participantIdentity:t})}function tt(e,t){h.debug("setting encryption enabled for all tracks of ".concat(t),{enable:e}),we.set(t,e)}function nt(e,t){return R(this,void 0,void 0,function*(){h.info("set shared key",{index:t}),yield te().setKey(e,t)})}function rt(e){e.on(M.Error,t=>{const n={kind:"error",data:{error:new Error("".concat(C[t.reason],": ").concat(t.message))}};postMessage(n)})}function it(e,t,n){postMessage({kind:"ratchetKey",data:{participantIdentity:t,keyIndex:n,ratchetResult:e}})}function st(e){me=e,B.forEach(t=>{t.setSifTrailer(e)})}self.RTCTransformEvent&&(h.debug("setup transform event"),self.onrtctransform=e=>{const t=e.transformer;h.debug("transformer",t);const{kind:n,participantIdentity:r,trackId:a,codec:s}=t.options,d=G(r,a);h.debug("transform",{codec:s}),d.setupTransform(n,t.readable,t.writable,a,!1,s)})})();
//# sourceMappingURL=livekit-client.e2ee.worker-Byc0H9ig.js.map
