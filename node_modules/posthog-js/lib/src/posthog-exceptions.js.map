{"version":3,"file":"posthog-exceptions.js","sourceRoot":"","sources":["../../src/posthog-exceptions.ts"],"names":[],"mappings":"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","sourcesContent":["import { ErrorPropertiesBuilder } from '@posthog/core/dist/error-tracking'\nimport { ERROR_TRACKING_CAPTURE_EXTENSION_EXCEPTIONS, ERROR_TRACKING_SUPPRESSION_RULES } from './constants'\nimport { PostHog } from './posthog-core'\nimport { CaptureResult, ErrorTrackingSuppressionRule, Properties, RemoteConfig } from './types'\nimport { createLogger } from './utils/logger'\nimport { propertyComparisons } from './utils/property-utils'\nimport { isString, isArray, ErrorTracking } from '@posthog/core'\n\nconst logger = createLogger('[Error tracking]')\n\nexport function buildErrorPropertiesBuilder() {\n    return new ErrorTracking.ErrorPropertiesBuilder(\n        [\n            new ErrorTracking.DOMExceptionCoercer(),\n            new ErrorTracking.PromiseRejectionEventCoercer(),\n            new ErrorTracking.ErrorEventCoercer(),\n            new ErrorTracking.ErrorCoercer(),\n            new ErrorTracking.EventCoercer(),\n            new ErrorTracking.ObjectCoercer(),\n            new ErrorTracking.StringCoercer(),\n            new ErrorTracking.PrimitiveCoercer(),\n        ],\n        [ErrorTracking.chromeStackLineParser, ErrorTracking.geckoStackLineParser]\n    )\n}\nexport class PostHogExceptions {\n    private readonly _instance: PostHog\n    private _suppressionRules: ErrorTrackingSuppressionRule[] = []\n    private _errorPropertiesBuilder: ErrorPropertiesBuilder = buildErrorPropertiesBuilder()\n\n    constructor(instance: PostHog) {\n        this._instance = instance\n        this._suppressionRules = this._instance.persistence?.get_property(ERROR_TRACKING_SUPPRESSION_RULES) ?? []\n    }\n\n    onRemoteConfig(response: RemoteConfig) {\n        const suppressionRules = response.errorTracking?.suppressionRules ?? []\n        const captureExtensionExceptions = response.errorTracking?.captureExtensionExceptions\n\n        // store this in-memory in case persistence is disabled\n        this._suppressionRules = suppressionRules\n\n        if (this._instance.persistence) {\n            this._instance.persistence.register({\n                [ERROR_TRACKING_SUPPRESSION_RULES]: this._suppressionRules,\n                [ERROR_TRACKING_CAPTURE_EXTENSION_EXCEPTIONS]: captureExtensionExceptions,\n            })\n        }\n    }\n\n    private get _captureExtensionExceptions() {\n        const enabled_server_side = !!this._instance.get_property(ERROR_TRACKING_CAPTURE_EXTENSION_EXCEPTIONS)\n        const enabled_client_side = this._instance.config.error_tracking.captureExtensionExceptions\n        return enabled_client_side ?? enabled_server_side ?? false\n    }\n\n    buildProperties(\n        input: unknown,\n        metadata?: { handled?: boolean; syntheticException?: Error }\n    ): ErrorTracking.ErrorProperties {\n        return this._errorPropertiesBuilder.buildFromUnknown(input, {\n            syntheticException: metadata?.syntheticException,\n            mechanism: {\n                handled: metadata?.handled,\n            },\n        })\n    }\n\n    sendExceptionEvent(properties: Properties): CaptureResult | undefined {\n        if (this._matchesSuppressionRule(properties)) {\n            logger.info('Skipping exception capture because a suppression rule matched')\n            return\n        }\n\n        if (!this._captureExtensionExceptions && this._isExtensionException(properties)) {\n            logger.info('Skipping exception capture because it was thrown by an extension')\n            return\n        }\n\n        return this._instance.capture('$exception', properties, {\n            _noTruncate: true,\n            _batchKey: 'exceptionEvent',\n        })\n    }\n\n    private _matchesSuppressionRule(properties: Properties): boolean {\n        const exceptionList = properties.$exception_list\n\n        if (!exceptionList || !isArray(exceptionList) || exceptionList.length === 0) {\n            return false\n        }\n\n        const exceptionValues = exceptionList.reduce(\n            (acc, { type, value }) => {\n                if (isString(type) && type.length > 0) {\n                    acc['$exception_types'].push(type)\n                }\n                if (isString(value) && value.length > 0) {\n                    acc['$exception_values'].push(value)\n                }\n                return acc\n            },\n            {\n                $exception_types: [],\n                $exception_values: [],\n            }\n        )\n\n        return this._suppressionRules.some((rule) => {\n            const results = rule.values.map((v) => {\n                const compare = propertyComparisons[v.operator]\n                const targets = isArray(v.value) ? v.value : [v.value]\n                const values = exceptionValues[v.key] ?? []\n                return targets.length > 0 ? compare(targets, values) : false\n            })\n            return rule.type === 'OR' ? results.some(Boolean) : results.every(Boolean)\n        })\n    }\n\n    private _isExtensionException(properties: Properties): boolean {\n        const exceptionList = properties.$exception_list\n\n        if (!exceptionList || !isArray(exceptionList)) {\n            return false\n        }\n\n        const frames = (exceptionList as ErrorTracking.Exception[]).flatMap((e) => e.stacktrace?.frames ?? [])\n        return frames.some((f) => f.filename && f.filename.startsWith('chrome-extension://'))\n    }\n}\n"]}