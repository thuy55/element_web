{"version":3,"file":"scroll-manager.js","sourceRoot":"","sources":["../../src/scroll-manager.ts"],"names":[],"mappings":"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","sourcesContent":["import { window } from './utils/globals'\nimport { PostHog } from './posthog-core'\nimport { addEventListener } from './utils'\nimport { isArray } from '@posthog/core'\n\nexport interface ScrollContext {\n    // scroll is how far down the page the user has scrolled,\n    // content is how far down the page the user can view content\n    // (e.g. if the page is 1000 tall, but the user's screen is only 500 tall,\n    // and they don't scroll at all, then scroll is 0 and content is 500)\n    maxScrollHeight?: number\n    maxScrollY?: number\n    lastScrollY?: number\n    maxContentHeight?: number\n    maxContentY?: number\n    lastContentY?: number\n}\n\n// This class is responsible for tracking scroll events and maintaining the scroll context\nexport class ScrollManager {\n    private _context: ScrollContext | undefined\n\n    constructor(private _instance: PostHog) {}\n\n    getContext(): ScrollContext | undefined {\n        return this._context\n    }\n\n    resetContext(): ScrollContext | undefined {\n        const ctx = this._context\n\n        // update the scroll properties for the new page, but wait until the next tick\n        // of the event loop\n        setTimeout(this._updateScrollData, 0)\n\n        return ctx\n    }\n\n    private _updateScrollData = () => {\n        if (!this._context) {\n            this._context = {}\n        }\n\n        const el = this.scrollElement()\n\n        const scrollY = this.scrollY()\n        const scrollHeight = el ? Math.max(0, el.scrollHeight - el.clientHeight) : 0\n        const contentY = scrollY + (el?.clientHeight || 0)\n        const contentHeight = el?.scrollHeight || 0\n\n        this._context.lastScrollY = Math.ceil(scrollY)\n        this._context.maxScrollY = Math.max(scrollY, this._context.maxScrollY ?? 0)\n        this._context.maxScrollHeight = Math.max(scrollHeight, this._context.maxScrollHeight ?? 0)\n\n        this._context.lastContentY = contentY\n        this._context.maxContentY = Math.max(contentY, this._context.maxContentY ?? 0)\n        this._context.maxContentHeight = Math.max(contentHeight, this._context.maxContentHeight ?? 0)\n    }\n\n    // `capture: true` is required to get scroll events for other scrollable elements\n    // on the page, not just the window\n    // see https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener#usecapture\n    startMeasuringScrollPosition() {\n        addEventListener(window, 'scroll', this._updateScrollData, { capture: true })\n        addEventListener(window, 'scrollend', this._updateScrollData, { capture: true })\n        addEventListener(window, 'resize', this._updateScrollData)\n    }\n\n    public scrollElement(): Element | undefined {\n        if (this._instance.config.scroll_root_selector) {\n            const selectors = isArray(this._instance.config.scroll_root_selector)\n                ? this._instance.config.scroll_root_selector\n                : [this._instance.config.scroll_root_selector]\n            for (const selector of selectors) {\n                const element = window?.document.querySelector(selector)\n                if (element) {\n                    return element\n                }\n            }\n            return undefined\n        } else {\n            return window?.document.documentElement\n        }\n    }\n\n    public scrollY(): number {\n        if (this._instance.config.scroll_root_selector) {\n            const element = this.scrollElement()\n            return (element && element.scrollTop) || 0\n        } else {\n            return window ? window.scrollY || window.pageYOffset || window.document.documentElement.scrollTop || 0 : 0\n        }\n    }\n\n    public scrollX(): number {\n        if (this._instance.config.scroll_root_selector) {\n            const element = this.scrollElement()\n            return (element && element.scrollLeft) || 0\n        } else {\n            return window ? window.scrollX || window.pageXOffset || window.document.documentElement.scrollLeft || 0 : 0\n        }\n    }\n}\n"]}