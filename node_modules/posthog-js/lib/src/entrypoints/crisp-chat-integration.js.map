{"version":3,"file":"crisp-chat-integration.js","sourceRoot":"","sources":["../../../src/entrypoints/crisp-chat-integration.ts"],"names":[],"mappings":";;AACA,4CAAmD;AACnD,0CAA8C;AAE9C,IAAM,MAAM,GAAG,IAAA,qBAAY,EAAC,sBAAsB,CAAC,CAAA;AAEnD,IAAM,kBAAkB,GAAG,IAAI,GAAG,EAAU,CAAA;AAC5C,IAAI,4BAA4B,GAA6B,SAAS,CAAA;AAEtE,0BAAgB,CAAC,qBAAqB,GAAG,0BAAgB,CAAC,qBAAqB,IAAI,EAAE,CAAA;AACrF,0BAAgB,CAAC,qBAAqB,CAAC,YAAY,GAAG,0BAAgB,CAAC,qBAAqB,CAAC,YAAY,IAAI,EAAE,CAAA;AAC/G,0BAAgB,CAAC,qBAAqB,CAAC,YAAY,CAAC,SAAS,GAAG;IAC5D,KAAK,EAAE,UAAC,OAAgB;;QACpB,IAAI,CAAC,CAAA,MAAA,OAAO,CAAC,MAAM,CAAC,YAAY,0CAAE,SAAS,CAAA,EAAE,CAAC;YAC1C,OAAM;QACV,CAAC;QAED,IAAM,SAAS,GAAI,0BAAwB,CAAC,MAAM,CAAA;QAClD,IAAI,CAAC,SAAS,EAAE,CAAC;YACb,MAAM,CAAC,IAAI,CAAC,yDAAyD,CAAC,CAAA;YACtE,OAAM;QACV,CAAC;QAED,IAAM,eAAe,GAAG;YACpB,IAAM,SAAS,GAAG,OAAO,CAAC,sBAAsB,EAAE,CAAA;YAClD,IAAM,SAAS,GAAG,OAAO,CAAC,aAAa,CAAC,WAAW,CAC/C,IAAI,EACJ,mBAAY,OAAO,CAAC,MAAM,CAAC,KAAK,qBAAW,OAAO,CAAC,eAAe,EAAE,CAAE,CACzE,CAAA;YAED,SAAS,CAAC,IAAI,CAAC;gBACX,KAAK;gBACL,cAAc;gBACd;oBACI;wBACI,CAAC,mBAAmB,EAAE,SAAS,CAAC;wBAChC,CAAC,kBAAkB,EAAE,SAAS,CAAC;qBAClC;iBACJ;aACJ,CAAC,CAAA;QACN,CAAC,CAAA;QAED,qDAAqD;QACrD,iDAAiD;QACjD,4BAA4B,GAAG,OAAO,CAAC,WAAW,CAAC,UAAC,SAAS;YACzD,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,SAAS,CAAC,EAAE,CAAC;gBACrC,eAAe,EAAE,CAAA;gBACjB,kBAAkB,CAAC,GAAG,CAAC,SAAS,CAAC,CAAA;YACrC,CAAC;QACL,CAAC,CAAC,CAAA;QAEF,MAAM,CAAC,IAAI,CAAC,qBAAqB,CAAC,CAAA;IACtC,CAAC;IACD,IAAI,EAAE;QACF,4BAA4B,aAA5B,4BAA4B,uBAA5B,4BAA4B,EAAI,CAAA;QAChC,4BAA4B,GAAG,SAAS,CAAA;IAC5C,CAAC;CACJ,CAAA","sourcesContent":["import { PostHog } from '../posthog-core'\nimport { assignableWindow } from '../utils/globals'\nimport { createLogger } from '../utils/logger'\n\nconst logger = createLogger('[PostHog Crisp Chat]')\n\nconst reportedSessionIds = new Set<string>()\nlet sessionIdListenerUnsubscribe: undefined | (() => void) = undefined\n\nassignableWindow.__PosthogExtensions__ = assignableWindow.__PosthogExtensions__ || {}\nassignableWindow.__PosthogExtensions__.integrations = assignableWindow.__PosthogExtensions__.integrations || {}\nassignableWindow.__PosthogExtensions__.integrations.crispChat = {\n    start: (posthog: PostHog) => {\n        if (!posthog.config.integrations?.crispChat) {\n            return\n        }\n\n        const crispChat = (assignableWindow as any).$crisp\n        if (!crispChat) {\n            logger.warn('Crisp Chat not found while initializing the integration')\n            return\n        }\n\n        const updateCrispChat = () => {\n            const replayUrl = posthog.get_session_replay_url()\n            const personUrl = posthog.requestRouter.endpointFor(\n                'ui',\n                `/project/${posthog.config.token}/person/${posthog.get_distinct_id()}`\n            )\n\n            crispChat.push([\n                'set',\n                'session:data',\n                [\n                    [\n                        ['posthogSessionURL', replayUrl],\n                        ['posthogPersonURL', personUrl],\n                    ],\n                ],\n            ])\n        }\n\n        // this is called immediately if there's a session id\n        // and then again whenever the session id changes\n        sessionIdListenerUnsubscribe = posthog.onSessionId((sessionId) => {\n            if (!reportedSessionIds.has(sessionId)) {\n                updateCrispChat()\n                reportedSessionIds.add(sessionId)\n            }\n        })\n\n        logger.info('integration started')\n    },\n    stop: () => {\n        sessionIdListenerUnsubscribe?.()\n        sessionIdListenerUnsubscribe = undefined\n    },\n}\n"]}