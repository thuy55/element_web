{"version":3,"file":"web-experiments.js","sourceRoot":"","sources":["../../src/web-experiments.ts"],"names":[],"mappings":"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","sourcesContent":["import { PostHog } from './posthog-core'\nimport { navigator, window } from './utils/globals'\nimport {\n    WebExperiment,\n    WebExperimentsCallback,\n    WebExperimentTransform,\n    WebExperimentUrlMatchType,\n    WebExperimentVariant,\n} from './web-experiments-types'\nimport { WEB_EXPERIMENTS } from './constants'\nimport { isNullish, isString } from '@posthog/core'\nimport { getQueryParam } from './utils/request-utils'\nimport { isMatchingRegex } from './utils/regex-utils'\nimport { logger } from './utils/logger'\nimport { isLikelyBot } from './utils/blocked-uas'\nimport { getCampaignParams } from './utils/event-utils'\n\nexport const webExperimentUrlValidationMap: Record<\n    WebExperimentUrlMatchType,\n    (conditionsUrl: string, location: Location) => boolean\n> = {\n    icontains: (conditionsUrl, location) =>\n        !!window && location.href.toLowerCase().indexOf(conditionsUrl.toLowerCase()) > -1,\n    not_icontains: (conditionsUrl, location) =>\n        !!window && location.href.toLowerCase().indexOf(conditionsUrl.toLowerCase()) === -1,\n    regex: (conditionsUrl, location) => !!window && isMatchingRegex(location.href, conditionsUrl),\n    not_regex: (conditionsUrl, location) => !!window && !isMatchingRegex(location.href, conditionsUrl),\n    exact: (conditionsUrl, location) => location.href === conditionsUrl,\n    is_not: (conditionsUrl, location) => location.href !== conditionsUrl,\n}\n\nexport class WebExperiments {\n    private _flagToExperiments?: Map<string, WebExperiment>\n\n    constructor(private _instance: PostHog) {\n        this._instance.onFeatureFlags((flags: string[]) => {\n            this.onFeatureFlags(flags)\n        })\n    }\n\n    onFeatureFlags(flags: string[]) {\n        if (this._is_bot()) {\n            WebExperiments._logInfo('Refusing to render web experiment since the viewer is a likely bot')\n            return\n        }\n\n        if (this._instance.config.disable_web_experiments) {\n            return\n        }\n\n        if (isNullish(this._flagToExperiments)) {\n            // Indicates first load so we trigger the loaders\n            this._flagToExperiments = new Map<string, WebExperiment>()\n            this.loadIfEnabled()\n            this.previewWebExperiment()\n            return\n        }\n\n        WebExperiments._logInfo('applying feature flags', flags)\n        flags.forEach((flag) => {\n            if (this._flagToExperiments && this._flagToExperiments?.has(flag)) {\n                const selectedVariant = this._instance.getFeatureFlag(flag) as unknown as string\n                const webExperiment = this._flagToExperiments?.get(flag)\n                if (selectedVariant && webExperiment?.variants[selectedVariant]) {\n                    this._applyTransforms(\n                        webExperiment.name,\n                        selectedVariant,\n                        webExperiment.variants[selectedVariant].transforms\n                    )\n                }\n            }\n        })\n    }\n\n    previewWebExperiment() {\n        const location = WebExperiments.getWindowLocation()\n        if (location?.search) {\n            const experimentID = getQueryParam(location?.search, '__experiment_id')\n            const variant = getQueryParam(location?.search, '__experiment_variant')\n            if (experimentID && variant) {\n                WebExperiments._logInfo(`previewing web experiments ${experimentID} && ${variant}`)\n                this.getWebExperiments(\n                    (webExperiments) => {\n                        this._showPreviewWebExperiment(parseInt(experimentID), variant, webExperiments)\n                    },\n                    false,\n                    true\n                )\n            }\n        }\n    }\n\n    loadIfEnabled() {\n        if (this._instance.config.disable_web_experiments) {\n            return\n        }\n\n        this.getWebExperimentsAndEvaluateDisplayLogic()\n    }\n\n    public getWebExperimentsAndEvaluateDisplayLogic = (forceReload: boolean = false): void => {\n        this.getWebExperiments((webExperiments) => {\n            WebExperiments._logInfo(`retrieved web experiments from the server`)\n            this._flagToExperiments = new Map<string, WebExperiment>()\n\n            webExperiments.forEach((webExperiment) => {\n                if (webExperiment.feature_flag_key) {\n                    if (this._flagToExperiments) {\n                        WebExperiments._logInfo(\n                            `setting flag key `,\n                            webExperiment.feature_flag_key,\n                            ` to web experiment `,\n                            webExperiment\n                        )\n                        this._flagToExperiments?.set(webExperiment.feature_flag_key, webExperiment)\n                    }\n\n                    const selectedVariant = this._instance.getFeatureFlag(webExperiment.feature_flag_key)\n                    if (isString(selectedVariant) && webExperiment.variants[selectedVariant]) {\n                        this._applyTransforms(\n                            webExperiment.name,\n                            selectedVariant,\n                            webExperiment.variants[selectedVariant].transforms\n                        )\n                    }\n                } else if (webExperiment.variants) {\n                    for (const variant in webExperiment.variants) {\n                        const testVariant = webExperiment.variants[variant]\n                        const matchTest = WebExperiments._matchesTestVariant(testVariant)\n                        if (matchTest) {\n                            this._applyTransforms(webExperiment.name, variant, testVariant.transforms)\n                        }\n                    }\n                }\n            })\n        }, forceReload)\n    }\n\n    public getWebExperiments(callback: WebExperimentsCallback, forceReload: boolean, previewing?: boolean) {\n        if (this._instance.config.disable_web_experiments && !previewing) {\n            return callback([])\n        }\n\n        const existingWebExperiments = this._instance.get_property(WEB_EXPERIMENTS)\n        if (existingWebExperiments && !forceReload) {\n            return callback(existingWebExperiments)\n        }\n\n        this._instance._send_request({\n            url: this._instance.requestRouter.endpointFor(\n                'api',\n                `/api/web_experiments/?token=${this._instance.config.token}`\n            ),\n            method: 'GET',\n            callback: (response) => {\n                if (response.statusCode !== 200 || !response.json) {\n                    return callback([])\n                }\n                const webExperiments = response.json.experiments || []\n                return callback(webExperiments)\n            },\n        })\n    }\n\n    private _showPreviewWebExperiment(experimentID: number, variant: string, webExperiments: WebExperiment[]) {\n        const previewExperiments = webExperiments.filter((exp) => exp.id === experimentID)\n        if (previewExperiments && previewExperiments.length > 0) {\n            WebExperiments._logInfo(\n                `Previewing web experiment [${previewExperiments[0].name}] with variant [${variant}]`\n            )\n            this._applyTransforms(\n                previewExperiments[0].name,\n                variant,\n                previewExperiments[0].variants[variant].transforms\n            )\n        }\n    }\n    private static _matchesTestVariant(testVariant: WebExperimentVariant) {\n        if (isNullish(testVariant.conditions)) {\n            return false\n        }\n        return WebExperiments._matchUrlConditions(testVariant) && WebExperiments._matchUTMConditions(testVariant)\n    }\n\n    private static _matchUrlConditions(testVariant: WebExperimentVariant): boolean {\n        if (isNullish(testVariant.conditions) || isNullish(testVariant.conditions?.url)) {\n            return true\n        }\n\n        const location = WebExperiments.getWindowLocation()\n        if (location) {\n            const urlCheck = testVariant.conditions?.url\n                ? webExperimentUrlValidationMap[testVariant.conditions?.urlMatchType ?? 'icontains'](\n                      testVariant.conditions.url,\n                      location\n                  )\n                : true\n            return urlCheck\n        }\n\n        return false\n    }\n\n    public static getWindowLocation(): Location | undefined {\n        return window?.location\n    }\n\n    private static _matchUTMConditions(testVariant: WebExperimentVariant): boolean {\n        if (isNullish(testVariant.conditions) || isNullish(testVariant.conditions?.utm)) {\n            return true\n        }\n        const campaignParams = getCampaignParams()\n        if (campaignParams['utm_source']) {\n            // eslint-disable-next-line compat/compat\n            const utmCampaignMatched = testVariant.conditions?.utm?.utm_campaign\n                ? testVariant.conditions?.utm?.utm_campaign == campaignParams['utm_campaign']\n                : true\n\n            const utmSourceMatched = testVariant.conditions?.utm?.utm_source\n                ? testVariant.conditions?.utm?.utm_source == campaignParams['utm_source']\n                : true\n\n            const utmMediumMatched = testVariant.conditions?.utm?.utm_medium\n                ? testVariant.conditions?.utm?.utm_medium == campaignParams['utm_medium']\n                : true\n\n            const utmTermMatched = testVariant.conditions?.utm?.utm_term\n                ? testVariant.conditions?.utm?.utm_term == campaignParams['utm_term']\n                : true\n\n            return utmCampaignMatched && utmMediumMatched && utmTermMatched && utmSourceMatched\n        }\n\n        return false\n    }\n\n    private static _logInfo(msg: string, ...args: any[]) {\n        logger.info(`[WebExperiments] ${msg}`, args)\n    }\n\n    private _applyTransforms(experiment: string, variant: string, transforms: WebExperimentTransform[]) {\n        if (this._is_bot()) {\n            WebExperiments._logInfo('Refusing to render web experiment since the viewer is a likely bot')\n            return\n        }\n\n        if (variant === 'control') {\n            WebExperiments._logInfo('Control variants leave the page unmodified.')\n            return\n        }\n\n        transforms.forEach((transform) => {\n            if (transform.selector) {\n                WebExperiments._logInfo(\n                    `applying transform of variant ${variant} for experiment ${experiment} `,\n                    transform\n                )\n\n                // eslint-disable-next-line no-restricted-globals\n                const elements = document?.querySelectorAll(transform.selector)\n                elements?.forEach((element) => {\n                    const htmlElement = element as HTMLElement\n                    if (transform.html) {\n                        htmlElement.innerHTML = transform.html\n                    }\n\n                    if (transform.css) {\n                        htmlElement.setAttribute('style', transform.css)\n                    }\n                })\n            }\n        })\n    }\n\n    _is_bot(): boolean | undefined {\n        if (navigator && this._instance) {\n            return isLikelyBot(navigator, this._instance.config.custom_blocked_useragents)\n        } else {\n            return undefined\n        }\n    }\n}\n"]}