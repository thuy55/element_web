{"version":3,"file":"action-matcher.js","sourceRoot":"","sources":["../../../../src/extensions/surveys/action-matcher.ts"],"names":[],"mappings":"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","sourcesContent":["import { PostHog } from '../../posthog-core'\nimport { ActionStepStringMatching, ActionStepType, SurveyActionType, SurveyElement } from '../../posthog-surveys-types'\nimport { SimpleEventEmitter } from '../../utils/simple-event-emitter'\nimport { CaptureResult } from '../../types'\nimport { isUndefined } from '@posthog/core'\nimport { window } from '../../utils/globals'\nimport { isMatchingRegex } from '../../utils/regex-utils'\n\nexport class ActionMatcher {\n    private readonly _actionRegistry?: Set<SurveyActionType>\n    private readonly _instance?: PostHog\n    private readonly _actionEvents: Set<string>\n    private _debugEventEmitter = new SimpleEventEmitter()\n\n    constructor(instance?: PostHog) {\n        this._instance = instance\n        this._actionEvents = new Set<string>()\n        this._actionRegistry = new Set<SurveyActionType>()\n    }\n\n    init() {\n        if (!isUndefined(this._instance?._addCaptureHook)) {\n            const matchEventToAction = (eventName: string, eventPayload: any) => {\n                this.on(eventName, eventPayload)\n            }\n            this._instance?._addCaptureHook(matchEventToAction)\n        }\n    }\n\n    register(actions: SurveyActionType[]): void {\n        if (isUndefined(this._instance?._addCaptureHook)) {\n            return\n        }\n\n        actions.forEach((action) => {\n            this._actionRegistry?.add(action)\n            action.steps?.forEach((step) => {\n                this._actionEvents?.add(step?.event || '')\n            })\n        })\n\n        if (this._instance?.autocapture) {\n            const selectorsToWatch: Set<string> = new Set<string>()\n            actions.forEach((action) => {\n                action.steps?.forEach((step) => {\n                    if (step?.selector) {\n                        selectorsToWatch.add(step?.selector)\n                    }\n                })\n            })\n            this._instance?.autocapture.setElementSelectors(selectorsToWatch)\n        }\n    }\n\n    on(eventName: string, eventPayload?: CaptureResult) {\n        if (eventPayload == null || eventName.length == 0) {\n            return\n        }\n\n        if (!this._actionEvents.has(eventName) && !this._actionEvents.has(<string>eventPayload?.event)) {\n            return\n        }\n\n        if (this._actionRegistry && this._actionRegistry?.size > 0) {\n            this._actionRegistry.forEach((action) => {\n                if (this._checkAction(eventPayload, action)) {\n                    this._debugEventEmitter.emit('actionCaptured', action.name)\n                }\n            })\n        }\n    }\n\n    _addActionHook(callback: (actionName: string, eventPayload?: any) => void): void {\n        this.onAction('actionCaptured', (data) => callback(data))\n    }\n\n    private _checkAction(event?: CaptureResult, action?: SurveyActionType): boolean {\n        if (action?.steps == null) {\n            return false\n        }\n\n        for (const step of action.steps) {\n            if (this._checkStep(event, step)) {\n                return true\n            }\n        }\n\n        return false\n    }\n\n    onAction(event: 'actionCaptured', cb: (...args: any[]) => void): () => void {\n        return this._debugEventEmitter.on(event, cb)\n    }\n\n    private _checkStep = (event?: CaptureResult, step?: ActionStepType): boolean => {\n        return (\n            this._checkStepEvent(event, step) && this._checkStepUrl(event, step) && this._checkStepElement(event, step)\n        )\n    }\n\n    private _checkStepEvent = (event?: CaptureResult, step?: ActionStepType): boolean => {\n        // CHECK CONDITIONS, OTHERWISE SKIPPED\n        if (step?.event && event?.event !== step?.event) {\n            return false // EVENT NAME IS A MISMATCH\n        }\n        return true\n    }\n\n    private _checkStepUrl(event?: CaptureResult, step?: ActionStepType): boolean {\n        // CHECK CONDITIONS, OTHERWISE SKIPPED\n        if (step?.url) {\n            const eventUrl = event?.properties?.$current_url\n            if (!eventUrl || typeof eventUrl !== 'string') {\n                return false // URL IS UNKNOWN\n            }\n            if (!ActionMatcher._matchString(eventUrl, step?.url, step?.url_matching || 'contains')) {\n                return false // URL IS A MISMATCH\n            }\n        }\n        return true\n    }\n\n    private static _matchString(url: string, pattern: string, matching: ActionStepStringMatching): boolean {\n        switch (matching) {\n            case 'regex':\n                return !!window && isMatchingRegex(url, pattern)\n            case 'exact':\n                return pattern === url\n            case 'contains':\n                // Simulating SQL LIKE behavior (_ = any single character, % = any zero or more characters)\n                // eslint-disable-next-line no-case-declarations\n                const adjustedRegExpStringPattern = ActionMatcher._escapeStringRegexp(pattern)\n                    .replace(/_/g, '.')\n                    .replace(/%/g, '.*')\n                return isMatchingRegex(url, adjustedRegExpStringPattern)\n\n            default:\n                return false\n        }\n    }\n\n    private static _escapeStringRegexp(pattern: string): string {\n        // Escape characters with special meaning either inside or outside character sets.\n        // Use a simple backslash escape when it’s always valid, and a `\\xnn` escape when the simpler form would be disallowed by Unicode patterns’ stricter grammar.\n        return pattern.replace(/[|\\\\{}()[\\]^$+*?.]/g, '\\\\$&').replace(/-/g, '\\\\x2d')\n    }\n\n    private _checkStepElement(event?: CaptureResult, step?: ActionStepType): boolean {\n        // CHECK CONDITIONS, OTHERWISE SKIPPED\n        if (step?.href || step?.tag_name || step?.text) {\n            const elements = this._getElementsList(event)\n            if (\n                !elements.some((element) => {\n                    if (\n                        step?.href &&\n                        !ActionMatcher._matchString(element.href || '', step?.href, step?.href_matching || 'exact')\n                    ) {\n                        return false // ELEMENT HREF IS A MISMATCH\n                    }\n                    if (step?.tag_name && element.tag_name !== step?.tag_name) {\n                        return false // ELEMENT TAG NAME IS A MISMATCH\n                    }\n                    if (\n                        step?.text &&\n                        !(\n                            ActionMatcher._matchString(\n                                element.text || '',\n                                step?.text,\n                                step?.text_matching || 'exact'\n                            ) ||\n                            ActionMatcher._matchString(\n                                element.$el_text || '',\n                                step?.text,\n                                step?.text_matching || 'exact'\n                            )\n                        )\n                    ) {\n                        return false // ELEMENT TEXT IS A MISMATCH\n                    }\n                    return true\n                })\n            ) {\n                // AT LEAST ONE ELEMENT MUST BE A SUBMATCH\n                return false\n            }\n        }\n\n        if (step?.selector) {\n            const elementSelectors = event?.properties?.$element_selectors as unknown as string[]\n            if (!elementSelectors) {\n                return false // SELECTOR IS A MISMATCH\n            }\n            if (!elementSelectors.includes(step?.selector)) {\n                return false // SELECTOR IS A MISMATCH\n            }\n        }\n\n        return true\n    }\n\n    private _getElementsList(event?: CaptureResult): SurveyElement[] {\n        if (event?.properties.$elements == null) {\n            return []\n        }\n\n        return event?.properties.$elements as unknown as SurveyElement[]\n    }\n}\n"]}