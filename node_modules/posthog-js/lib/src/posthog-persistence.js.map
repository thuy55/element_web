{"version":3,"file":"posthog-persistence.js","sourceRoot":"","sources":["../../src/posthog-persistence.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint camelcase: \"off\" */\n\nimport { each, extend, include, stripEmptyProperties } from './utils'\nimport { cookieStore, localPlusCookieStore, localStore, memoryStore, sessionStore } from './storage'\nimport { PersistentStore, PostHogConfig, Properties } from './types'\nimport {\n    ENABLED_FEATURE_FLAGS,\n    EVENT_TIMERS_KEY,\n    INITIAL_CAMPAIGN_PARAMS,\n    INITIAL_PERSON_INFO,\n    INITIAL_REFERRER_INFO,\n    PERSISTENCE_RESERVED_PROPERTIES,\n} from './constants'\n\nimport { isUndefined } from '@posthog/core'\nimport {\n    getCampaignParams,\n    getInitialPersonPropsFromInfo,\n    getPersonInfo,\n    getReferrerInfo,\n    getSearchInfo,\n} from './utils/event-utils'\nimport { logger } from './utils/logger'\nimport { stripLeadingDollar, isEmptyObject, isObject } from '@posthog/core'\n\nconst CASE_INSENSITIVE_PERSISTENCE_TYPES: readonly Lowercase<PostHogConfig['persistence']>[] = [\n    'cookie',\n    'localstorage',\n    'localstorage+cookie',\n    'sessionstorage',\n    'memory',\n]\n\nconst parseName = (config: PostHogConfig): string => {\n    let token = ''\n    if (config['token']) {\n        token = config['token'].replace(/\\+/g, 'PL').replace(/\\//g, 'SL').replace(/=/g, 'EQ')\n    }\n\n    if (config['persistence_name']) {\n        return 'ph_' + config['persistence_name']\n    } else {\n        return 'ph_' + token + '_posthog'\n    }\n}\n\n/**\n * PostHog Persistence Object\n * @constructor\n */\nexport class PostHogPersistence {\n    private _config: PostHogConfig\n    props: Properties\n    private _storage: PersistentStore\n    private _campaign_params_saved: boolean\n    private readonly _name: string\n    _disabled: boolean | undefined\n    private _secure: boolean | undefined\n    private _expire_days: number | undefined\n    private _default_expiry: number | undefined\n    private _cross_subdomain: boolean | undefined\n\n    /**\n     * @param {PostHogConfig} config initial PostHog configuration\n     * @param {boolean=} isDisabled should persistence be disabled (e.g. because of consent management)\n     */\n    constructor(config: PostHogConfig, isDisabled?: boolean) {\n        this._config = config\n        this.props = {}\n        this._campaign_params_saved = false\n        this._name = parseName(config)\n        this._storage = this._buildStorage(config)\n        this.load()\n        if (config.debug) {\n            logger.info('Persistence loaded', config['persistence'], { ...this.props })\n        }\n        this.update_config(config, config, isDisabled)\n        this.save()\n    }\n\n    public isDisabled(): boolean {\n        return !!this._disabled\n    }\n\n    private _buildStorage(config: PostHogConfig) {\n        if (\n            CASE_INSENSITIVE_PERSISTENCE_TYPES.indexOf(\n                config['persistence'].toLowerCase() as Lowercase<PostHogConfig['persistence']>\n            ) === -1\n        ) {\n            logger.critical(\n                'Unknown persistence type ' + config['persistence'] + '; falling back to localStorage+cookie'\n            )\n            config['persistence'] = 'localStorage+cookie'\n        }\n\n        let store: PersistentStore\n        // We handle storage type in a case-insensitive way for backwards compatibility\n        const storage_type = config['persistence'].toLowerCase() as Lowercase<PostHogConfig['persistence']>\n        if (storage_type === 'localstorage' && localStore._is_supported()) {\n            store = localStore\n        } else if (storage_type === 'localstorage+cookie' && localPlusCookieStore._is_supported()) {\n            store = localPlusCookieStore\n        } else if (storage_type === 'sessionstorage' && sessionStore._is_supported()) {\n            store = sessionStore\n        } else if (storage_type === 'memory') {\n            store = memoryStore\n        } else if (storage_type === 'cookie') {\n            store = cookieStore\n        } else if (localPlusCookieStore._is_supported()) {\n            // selected storage type wasn't supported, fallback to 'localstorage+cookie' if possible\n            store = localPlusCookieStore\n        } else {\n            store = cookieStore\n        }\n\n        return store\n    }\n\n    properties(): Properties {\n        const p: Properties = {}\n        // Filter out reserved properties\n        each(this.props, function (v, k) {\n            if (k === ENABLED_FEATURE_FLAGS && isObject(v)) {\n                const keys = Object.keys(v)\n                for (let i = 0; i < keys.length; i++) {\n                    p[`$feature/${keys[i]}`] = v[keys[i]]\n                }\n            } else if (!include(PERSISTENCE_RESERVED_PROPERTIES, k)) {\n                p[k] = v\n            }\n        })\n        return p\n    }\n\n    load(): void {\n        if (this._disabled) {\n            return\n        }\n\n        const entry = this._storage._parse(this._name)\n\n        if (entry) {\n            this.props = extend({}, entry)\n        }\n    }\n\n    /**\n     * NOTE: Saving frequently causes issues with Recordings and Consent Management Platform (CMP) tools which\n     * observe cookie changes, and modify their UI, often causing infinite loops.\n     * As such callers of this should ideally check that the data has changed beforehand\n     */\n    save(): void {\n        if (this._disabled) {\n            return\n        }\n        this._storage._set(\n            this._name,\n            this.props,\n            this._expire_days,\n            this._cross_subdomain,\n            this._secure,\n            this._config.debug\n        )\n    }\n\n    remove(): void {\n        // remove both domain and subdomain cookies\n        this._storage._remove(this._name, false)\n        this._storage._remove(this._name, true)\n    }\n\n    // removes the storage entry and deletes all loaded data\n    // forced name for tests\n\n    clear(): void {\n        this.remove()\n        this.props = {}\n    }\n\n    /**\n     * @param {Object} props\n     * @param {*=} default_value\n     * @param {number=} days\n     */\n\n    register_once(props: Properties, default_value: any, days?: number): boolean {\n        if (isObject(props)) {\n            if (isUndefined(default_value)) {\n                default_value = 'None'\n            }\n            this._expire_days = isUndefined(days) ? this._default_expiry : days\n\n            let hasChanges = false\n\n            each(props, (val, prop) => {\n                if (!this.props.hasOwnProperty(prop) || this.props[prop] === default_value) {\n                    this.props[prop] = val\n                    hasChanges = true\n                }\n            })\n\n            if (hasChanges) {\n                this.save()\n                return true\n            }\n        }\n        return false\n    }\n\n    /**\n     * @param {Object} props\n     * @param {number=} days\n     */\n\n    register(props: Properties, days?: number): boolean {\n        if (isObject(props)) {\n            this._expire_days = isUndefined(days) ? this._default_expiry : days\n\n            let hasChanges = false\n\n            each(props, (val, prop) => {\n                if (props.hasOwnProperty(prop) && this.props[prop] !== val) {\n                    this.props[prop] = val\n                    hasChanges = true\n                }\n            })\n\n            if (hasChanges) {\n                this.save()\n                return true\n            }\n        }\n        return false\n    }\n\n    unregister(prop: string): void {\n        if (prop in this.props) {\n            delete this.props[prop]\n            this.save()\n        }\n    }\n\n    update_campaign_params(): void {\n        if (!this._campaign_params_saved) {\n            const campaignParams = getCampaignParams(\n                this._config.custom_campaign_params,\n                this._config.mask_personal_data_properties,\n                this._config.custom_personal_data_properties\n            )\n            // only save campaign params if there were any\n            if (!isEmptyObject(stripEmptyProperties(campaignParams))) {\n                this.register(campaignParams)\n            }\n            this._campaign_params_saved = true\n        }\n    }\n    update_search_keyword(): void {\n        this.register(getSearchInfo())\n    }\n\n    update_referrer_info(): void {\n        this.register_once(getReferrerInfo(), undefined)\n    }\n\n    set_initial_person_info(): void {\n        if (this.props[INITIAL_CAMPAIGN_PARAMS] || this.props[INITIAL_REFERRER_INFO]) {\n            // the user has initial properties stored the previous way, don't save them again\n            return\n        }\n\n        this.register_once(\n            {\n                [INITIAL_PERSON_INFO]: getPersonInfo(\n                    this._config.mask_personal_data_properties,\n                    this._config.custom_personal_data_properties\n                ),\n            },\n            undefined\n        )\n    }\n\n    get_initial_props(): Properties {\n        const p: Properties = {}\n\n        // this section isn't written to anymore, but we should keep reading from it for backwards compatibility\n        // for a while\n        each([INITIAL_REFERRER_INFO, INITIAL_CAMPAIGN_PARAMS], (key) => {\n            const initialReferrerInfo = this.props[key]\n            if (initialReferrerInfo) {\n                each(initialReferrerInfo, function (v, k) {\n                    p['$initial_' + stripLeadingDollar(k)] = v\n                })\n            }\n        })\n        const initialPersonInfo = this.props[INITIAL_PERSON_INFO]\n        if (initialPersonInfo) {\n            const initialPersonProps = getInitialPersonPropsFromInfo(initialPersonInfo)\n            extend(p, initialPersonProps)\n        }\n\n        return p\n    }\n\n    // safely fills the passed in object with stored properties,\n    // does not override any properties defined in both\n    // returns the passed in object\n\n    safe_merge(props: Properties): Properties {\n        each(this.props, function (val, prop) {\n            if (!(prop in props)) {\n                props[prop] = val\n            }\n        })\n\n        return props\n    }\n\n    update_config(config: PostHogConfig, oldConfig: PostHogConfig, isDisabled?: boolean): void {\n        this._default_expiry = this._expire_days = config['cookie_expiration']\n        this.set_disabled(config['disable_persistence'] || !!isDisabled)\n        this.set_cross_subdomain(config['cross_subdomain_cookie'])\n        this.set_secure(config['secure_cookie'])\n\n        if (config.persistence !== oldConfig.persistence) {\n            // If the persistence type has changed, we need to migrate the data.\n            const newStore = this._buildStorage(config)\n            const props = this.props\n\n            // clear the old store\n            this.clear()\n            this._storage = newStore\n            this.props = props\n\n            this.save()\n        }\n    }\n\n    set_disabled(disabled: boolean): void {\n        this._disabled = disabled\n        if (this._disabled) {\n            this.remove()\n        } else {\n            this.save()\n        }\n    }\n\n    set_cross_subdomain(cross_subdomain: boolean): void {\n        if (cross_subdomain !== this._cross_subdomain) {\n            this._cross_subdomain = cross_subdomain\n            this.remove()\n            this.save()\n        }\n    }\n\n    set_secure(secure: boolean): void {\n        if (secure !== this._secure) {\n            this._secure = secure\n            this.remove()\n            this.save()\n        }\n    }\n\n    set_event_timer(event_name: string, timestamp: number): void {\n        const timers = this.props[EVENT_TIMERS_KEY] || {}\n        timers[event_name] = timestamp\n        this.props[EVENT_TIMERS_KEY] = timers\n        this.save()\n    }\n\n    remove_event_timer(event_name: string): number {\n        const timers = this.props[EVENT_TIMERS_KEY] || {}\n        const timestamp = timers[event_name]\n        if (!isUndefined(timestamp)) {\n            delete this.props[EVENT_TIMERS_KEY][event_name]\n            this.save()\n        }\n        return timestamp\n    }\n\n    get_property(prop: string): any {\n        return this.props[prop]\n    }\n\n    set_property(prop: string, to: any): void {\n        this.props[prop] = to\n        this.save()\n    }\n}\n"]}