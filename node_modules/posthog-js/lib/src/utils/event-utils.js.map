{"version":3,"file":"event-utils.js","sourceRoot":"","sources":["../../../src/utils/event-utils.ts"],"names":[],"mappings":"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","sourcesContent":["import { convertToURL, getQueryParam, maskQueryParams } from './request-utils'\nimport { isNull, stripLeadingDollar } from '@posthog/core'\nimport { Properties } from '../types'\nimport Config from '../config'\nimport { each, extend, extendArray, stripEmptyProperties } from './index'\nimport { document, location, userAgent, window } from './globals'\nimport { detectBrowser, detectBrowserVersion, detectDevice, detectDeviceType, detectOS } from './user-agent-utils'\nimport { cookieStore } from '../storage'\n\nconst URL_REGEX_PREFIX = 'https?://(.*)'\n\n// CAMPAIGN_PARAMS and EVENT_TO_PERSON_PROPERTIES should be kept in sync with\n// https://github.com/PostHog/posthog/blob/master/plugin-server/src/utils/db/utils.ts#L60\n\n// The list of campaign parameters that could be considered personal data under e.g. GDPR.\n// These can be masked in URLs and properties before being sent to posthog.\nexport const PERSONAL_DATA_CAMPAIGN_PARAMS = [\n    'gclid', // google ads\n    'gclsrc', // google ads 360\n    'dclid', // google display ads\n    'gbraid', // google ads, web to app\n    'wbraid', // google ads, app to web\n    'fbclid', // facebook\n    'msclkid', // microsoft\n    'twclid', // twitter\n    'li_fat_id', // linkedin\n    'igshid', // instagram\n    'ttclid', // tiktok\n    'rdt_cid', // reddit\n    'epik', // pinterest\n    'qclid', // quora\n    'sccid', // snapchat\n    'irclid', // impact\n    '_kx', // klaviyo\n]\n\nexport const CAMPAIGN_PARAMS = extendArray(\n    [\n        'utm_source',\n        'utm_medium',\n        'utm_campaign',\n        'utm_content',\n        'utm_term',\n        'gad_source', // google ads source\n        'mc_cid', // mailchimp campaign id\n    ],\n    PERSONAL_DATA_CAMPAIGN_PARAMS\n)\n\nexport const EVENT_TO_PERSON_PROPERTIES = [\n    // mobile params\n    '$app_build',\n    '$app_name',\n    '$app_namespace',\n    '$app_version',\n    // web params\n    '$browser',\n    '$browser_version',\n    '$device_type',\n    '$current_url',\n    '$pathname',\n    '$os',\n    '$os_name', // $os_name is a special case, it's treated as an alias of $os!\n    '$os_version',\n    '$referring_domain',\n    '$referrer',\n    '$screen_height',\n    '$screen_width',\n    '$viewport_height',\n    '$viewport_width',\n    '$raw_user_agent',\n]\n\nexport const MASKED = '<masked>'\n\n// Campaign params that can be read from the cookie store\nexport const COOKIE_CAMPAIGN_PARAMS = [\n    'li_fat_id', // linkedin\n]\n\nexport function getCampaignParams(\n    customTrackedParams?: string[],\n    maskPersonalDataProperties?: boolean,\n    customPersonalDataProperties?: string[] | undefined\n): Record<string, string> {\n    if (!document) {\n        return {}\n    }\n\n    const paramsToMask = maskPersonalDataProperties\n        ? extendArray([], PERSONAL_DATA_CAMPAIGN_PARAMS, customPersonalDataProperties || [])\n        : []\n\n    // Initially get campaign params from the URL\n    const urlCampaignParams = _getCampaignParamsFromUrl(\n        maskQueryParams(document.URL, paramsToMask, MASKED),\n        customTrackedParams\n    )\n\n    // But we can also get some of them from the cookie store\n    // For example: https://learn.microsoft.com/en-us/linkedin/marketing/conversions/enabling-first-party-cookies?view=li-lms-2025-05#reading-li_fat_id-from-cookies\n    const cookieCampaignParams = _getCampaignParamsFromCookie()\n\n    // Prefer the values found in the urlCampaignParams if possible\n    // `extend` will override the values if found in the second argument\n    return extend(cookieCampaignParams, urlCampaignParams)\n}\n\nfunction _getCampaignParamsFromUrl(url: string, customParams?: string[]): Record<string, string> {\n    const campaign_keywords = CAMPAIGN_PARAMS.concat(customParams || [])\n\n    const params: Record<string, any> = {}\n    each(campaign_keywords, function (kwkey) {\n        const kw = getQueryParam(url, kwkey)\n        params[kwkey] = kw ? kw : null\n    })\n\n    return params\n}\n\nfunction _getCampaignParamsFromCookie(): Record<string, string> {\n    const params: Record<string, any> = {}\n    each(COOKIE_CAMPAIGN_PARAMS, function (kwkey) {\n        const kw = cookieStore._get(kwkey)\n        params[kwkey] = kw ? kw : null\n    })\n\n    return params\n}\n\nfunction _getSearchEngine(referrer: string): string | null {\n    if (!referrer) {\n        return null\n    } else {\n        if (referrer.search(URL_REGEX_PREFIX + 'google.([^/?]*)') === 0) {\n            return 'google'\n        } else if (referrer.search(URL_REGEX_PREFIX + 'bing.com') === 0) {\n            return 'bing'\n        } else if (referrer.search(URL_REGEX_PREFIX + 'yahoo.com') === 0) {\n            return 'yahoo'\n        } else if (referrer.search(URL_REGEX_PREFIX + 'duckduckgo.com') === 0) {\n            return 'duckduckgo'\n        } else {\n            return null\n        }\n    }\n}\n\nfunction _getSearchInfoFromReferrer(referrer: string): Record<string, any> {\n    const search = _getSearchEngine(referrer)\n    const param = search != 'yahoo' ? 'q' : 'p'\n    const ret: Record<string, any> = {}\n\n    if (!isNull(search)) {\n        ret['$search_engine'] = search\n\n        const keyword = document ? getQueryParam(document.referrer, param) : ''\n        if (keyword.length) {\n            ret['ph_keyword'] = keyword\n        }\n    }\n\n    return ret\n}\n\nexport function getSearchInfo(): Record<string, any> {\n    const referrer = document?.referrer\n    if (!referrer) {\n        return {}\n    }\n    return _getSearchInfoFromReferrer(referrer)\n}\n\nexport function getBrowserLanguage(): string | undefined {\n    return (\n        navigator.language || // Any modern browser\n        (navigator as Record<string, any>).userLanguage // IE11\n    )\n}\n\nexport function getBrowserLanguagePrefix(): string | undefined {\n    const lang = getBrowserLanguage()\n    return typeof lang === 'string' ? lang.split('-')[0] : undefined\n}\n\nexport function getReferrer(): string {\n    return document?.referrer || '$direct'\n}\n\nexport function getReferringDomain(): string {\n    if (!document?.referrer) {\n        return '$direct'\n    }\n    return convertToURL(document.referrer)?.host || '$direct'\n}\n\nexport function getReferrerInfo(): Record<string, any> {\n    return {\n        $referrer: getReferrer(),\n        $referring_domain: getReferringDomain(),\n    }\n}\n\nexport function getPersonInfo(maskPersonalDataProperties?: boolean, customPersonalDataProperties?: string[]) {\n    const paramsToMask = maskPersonalDataProperties\n        ? extendArray([], PERSONAL_DATA_CAMPAIGN_PARAMS, customPersonalDataProperties || [])\n        : []\n    const url = location?.href.substring(0, 1000)\n    // we're being a bit more economical with bytes here because this is stored in the cookie\n    return {\n        r: getReferrer().substring(0, 1000),\n        u: url ? maskQueryParams(url, paramsToMask, MASKED) : undefined,\n    }\n}\n\nexport function getPersonPropsFromInfo(info: Record<string, any>): Record<string, any> {\n    const { r: referrer, u: url } = info\n    const referring_domain =\n        referrer == null ? undefined : referrer == '$direct' ? '$direct' : convertToURL(referrer)?.host\n\n    const props: Record<string, string | undefined> = {\n        $referrer: referrer,\n        $referring_domain: referring_domain,\n    }\n    if (url) {\n        props['$current_url'] = url\n        const location = convertToURL(url)\n        props['$host'] = location?.host\n        props['$pathname'] = location?.pathname\n        const campaignParams = _getCampaignParamsFromUrl(url)\n        extend(props, campaignParams)\n    }\n    if (referrer) {\n        const searchInfo = _getSearchInfoFromReferrer(referrer)\n        extend(props, searchInfo)\n    }\n    return props\n}\n\nexport function getInitialPersonPropsFromInfo(info: Record<string, any>): Record<string, any> {\n    const personProps = getPersonPropsFromInfo(info)\n    const props: Record<string, any> = {}\n    each(personProps, function (val: any, key: string) {\n        props[`$initial_${stripLeadingDollar(key)}`] = val\n    })\n    return props\n}\n\nexport function getTimezone(): string | undefined {\n    try {\n        return Intl.DateTimeFormat().resolvedOptions().timeZone\n    } catch {\n        return undefined\n    }\n}\n\nexport function getTimezoneOffset(): number | undefined {\n    try {\n        return new Date().getTimezoneOffset()\n    } catch {\n        return undefined\n    }\n}\n\nexport function getEventProperties(\n    maskPersonalDataProperties?: boolean,\n    customPersonalDataProperties?: string[]\n): Properties {\n    if (!userAgent) {\n        return {}\n    }\n    const paramsToMask = maskPersonalDataProperties\n        ? extendArray([], PERSONAL_DATA_CAMPAIGN_PARAMS, customPersonalDataProperties || [])\n        : []\n    const [os_name, os_version] = detectOS(userAgent)\n    return extend(\n        stripEmptyProperties({\n            $os: os_name,\n            $os_version: os_version,\n            $browser: detectBrowser(userAgent, navigator.vendor),\n            $device: detectDevice(userAgent),\n            $device_type: detectDeviceType(userAgent),\n            $timezone: getTimezone(),\n            $timezone_offset: getTimezoneOffset(),\n        }),\n        {\n            $current_url: maskQueryParams(location?.href, paramsToMask, MASKED),\n            $host: location?.host,\n            $pathname: location?.pathname,\n            $raw_user_agent: userAgent.length > 1000 ? userAgent.substring(0, 997) + '...' : userAgent,\n            $browser_version: detectBrowserVersion(userAgent, navigator.vendor),\n            $browser_language: getBrowserLanguage(),\n            $browser_language_prefix: getBrowserLanguagePrefix(),\n            $screen_height: window?.screen.height,\n            $screen_width: window?.screen.width,\n            $viewport_height: window?.innerHeight,\n            $viewport_width: window?.innerWidth,\n            $lib: 'web',\n            $lib_version: Config.LIB_VERSION,\n            $insert_id: Math.random().toString(36).substring(2, 10) + Math.random().toString(36).substring(2, 10),\n            $time: Date.now() / 1000, // epoch time in seconds\n        }\n    )\n}\n"]}